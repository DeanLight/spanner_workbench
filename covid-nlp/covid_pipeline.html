<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spannerlib - Covid-19 NLP Pipeline</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Spannerlib - Covid-19 NLP Pipeline">
<meta property="og:description" content="work bench">
<meta property="og:site_name" content="Spannerlib">
<meta name="twitter:title" content="Spannerlib - Covid-19 NLP Pipeline">
<meta name="twitter:description" content="work bench">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Spannerlib</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../introduction.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../covid-nlp/covid_pipeline.html">Covid-19 NLP Pipeline</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to Spannerlib</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stdlib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Standard library ie functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../advanced_usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced Usage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../building_your_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Building your own optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../extended_version.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced IE functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../covid-nlp/covid_pipeline.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Covid-19 NLP Pipeline</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">src</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Generic</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../general_utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../primitive_types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Primitive Types</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Grammar &amp; Parsing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../expected_grammar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Expected Grammar</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../symbol_table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Symbol Table</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lark_passes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lark Passes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../passes_utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Passes Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../optimizations_passes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimizations Passes</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Engine</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../engine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Engine</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../execution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Execution</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Graphs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ast_node_types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ast Nodes Types</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ie_function.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IE Function</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graphs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../adding_inference_rules_to_term_graph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Adding inference rules to term graph</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">User-Interface</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Session</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#tutorial-introduction" id="toc-tutorial-introduction" class="nav-link active" data-scroll-target="#tutorial-introduction">Tutorial Introduction:</a>
  <ul class="collapse">
  <li><a href="#understanding-the-covid-19-nlp-pipeline" id="toc-understanding-the-covid-19-nlp-pipeline" class="nav-link" data-scroll-target="#understanding-the-covid-19-nlp-pipeline">Understanding The Covid-19 NLP Pipeline:</a></li>
  <li><a href="#pipline-stages" id="toc-pipline-stages" class="nav-link" data-scroll-target="#pipline-stages">Pipline Stages:</a></li>
  </ul></li>
  <li><a href="#implementation---step-by-step" id="toc-implementation---step-by-step" class="nav-link" data-scroll-target="#implementation---step-by-step">Implementation - step by step:</a>
  <ul class="collapse">
  <li><a href="#setting-up-the-environment" id="toc-setting-up-the-environment" class="nav-link" data-scroll-target="#setting-up-the-environment">Setting Up The Environment:</a></li>
  <li><a href="#pipeline-input" id="toc-pipeline-input" class="nav-link" data-scroll-target="#pipeline-input">Pipeline Input:</a></li>
  <li><a href="#concept-tagger" id="toc-concept-tagger" class="nav-link" data-scroll-target="#concept-tagger">Concept Tagger:</a></li>
  <li><a href="#lemma-rules" id="toc-lemma-rules" class="nav-link" data-scroll-target="#lemma-rules">Lemma Rules:</a></li>
  <li><a href="#pos-rules" id="toc-pos-rules" class="nav-link" data-scroll-target="#pos-rules">POS Rules:</a></li>
  <li><a href="#target-rules" id="toc-target-rules" class="nav-link" data-scroll-target="#target-rules">Target Rules:</a></li>
  <li><a href="#section-rules" id="toc-section-rules" class="nav-link" data-scroll-target="#section-rules">Section Rules:</a></li>
  <li><a href="#attribute-assertion" id="toc-attribute-assertion" class="nav-link" data-scroll-target="#attribute-assertion">Attribute Assertion:</a></li>
  <li><a href="#tokenizing-the-text-into-sentences" id="toc-tokenizing-the-text-into-sentences" class="nav-link" data-scroll-target="#tokenizing-the-text-into-sentences">Tokenizing the Text into Sentences:</a></li>
  <li><a href="#context-rules" id="toc-context-rules" class="nav-link" data-scroll-target="#context-rules">Context Rules:</a></li>
  <li><a href="#postprocessor" id="toc-postprocessor" class="nav-link" data-scroll-target="#postprocessor">Postprocessor:</a></li>
  <li><a href="#document-classifier" id="toc-document-classifier" class="nav-link" data-scroll-target="#document-classifier">Document Classifier:</a></li>
  </ul></li>
  <li><a href="#bringing-it-all-together" id="toc-bringing-it-all-together" class="nav-link" data-scroll-target="#bringing-it-all-together">Bringing It All Together</a>
  <ul class="collapse">
  <li><a href="#code-metrics" id="toc-code-metrics" class="nav-link" data-scroll-target="#code-metrics">Code Metrics</a></li>
  <li><a href="#implementation---raw-lines-of-code" id="toc-implementation---raw-lines-of-code" class="nav-link" data-scroll-target="#implementation---raw-lines-of-code">Implementation - raw lines of code</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/DeanLight/spannerlib/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../introduction.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../covid-nlp/covid_pipeline.html">Covid-19 NLP Pipeline</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Covid-19 NLP Pipeline</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="tutorial-introduction" class="level2">
<h2 class="anchored" data-anchor-id="tutorial-introduction">Tutorial Introduction:</h2>
<p>In this tutorial, we will guide you through the process of re-writing an existing data pipeline into the spannerlog framework, allowing you to witness a real-world example of the framework’s benefits. And to offer further tutorials on advanced applications of the spannerlog framework. We’ve chosen to adapt a pipeline from the field of NLP, specifically the Covid-19 NLP pipeline, which was a part of a published <a href="https://aclanthology.org/2020.nlpcovid19-acl.10.pdf">paper</a> in 2020.</p>
<section id="understanding-the-covid-19-nlp-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="understanding-the-covid-19-nlp-pipeline">Understanding The Covid-19 NLP Pipeline:</h3>
<p>The pipline repository <a href="https://github.com/abchapman93/VA_COVID-19_NLP_BSV/">link</a>.</p>
<p>The primary objective of the NLP pipeline is to identify individuals who have been positively diagnosed with COVID-19 by extracting pertinent information from unstructured free-text narratives found within the Electronic Health Record (EHR) of the Department of Veterans Affairs (VA). By automating this process, the pipeline streamlines the screening of a substantial volume of clinical text, significantly reducing the time and effort required for identification. The pipeline is built on medSpacy framework, and defines a new UI to use.</p>
</section>
<section id="pipline-stages" class="level3">
<h3 class="anchored" data-anchor-id="pipline-stages">Pipline Stages:</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/pipeline_flowchart.png" class="img-fluid figure-img"></p>
<figcaption>pipeline_flowchart</figcaption>
</figure>
</div>
<ul>
<li>preprocessor: Modifies the preprocessed text</li>
<li>concept tagger: Assigns a semantic tag in a custom attribute to each Token, which helps with concept extraction and normalization.</li>
<li>target matcher: Extracts spans using rules, based on the concept tagger.</li>
<li>sectionizer: Identifies note section headers in the text and assigns section titles to entities and tokens contained in that section.</li>
<li>context: Identifies semantic modifiers of entities and asserts attributes such as positive status, negation, and other experiencier.</li>
<li>postprocessor: Modifies or removes the entity based on business logic. This handles special cases or complex logic using the results of earlier stages.</li>
<li>document classifier: Assigns a label of “POS”, “UNK”, or “NEG” to each file, A document will be classified as positive if it has at least one positive, non-excluded entity We will explain about each stage in more details later on.</li>
</ul>
<p>At each stage, we encountered unique challenges. Each stage involved working with different classes and medSpacy framework attributes. Our approach was to first understand the original implementation, seek opportunities to simplify it, and then rewrite it in spannerlog. What was possible we wrote it declaratively using rules, facts, and queries. Additionally, if any essential functionalities were missing in the library, we built IE functions. As we mentioned the pipline uses medSpacy framework so first we need to import some libraries and install some requirements.</p>
</section>
</section>
<section id="implementation---step-by-step" class="level2">
<h2 class="anchored" data-anchor-id="implementation---step-by-step">Implementation - step by step:</h2>
<section id="setting-up-the-environment" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-the-environment">Setting Up The Environment:</h3>
<p>We need to install some requirements to work with <a href="https://github.com/medspacy/medspacy">medspacy</a> framework</p>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install spacy</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> python <span class="op">-</span>m spacy download en_core_web_sm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Installing and importing primitives from the framework</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install spannerlib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas <span class="im">import</span> DataFrame</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spannerlib</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib.session <span class="im">import</span> Session</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib.primitive_types <span class="im">import</span> Span, DataTypes</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib <span class="im">import</span> magic_session</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Defining some generic ie functions that will be used in every stage of the pipline:</p>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_from_file(text_path):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Reads from file and return it's content.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">        text_path (str): The path to the text file to read from.</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">        str: The content of the file.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>text_path<span class="sc">}</span><span class="ss">"</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> content</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>magic_session.register(ie_function<span class="op">=</span>read_from_file,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                       ie_function_name <span class="op">=</span> <span class="st">"read_from_file"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                       in_rel<span class="op">=</span>[DataTypes.string],</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                       out_rel<span class="op">=</span>[DataTypes.string])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> value <span class="kw">in</span> read_from_file(<span class="st">"sample1.txt"</span>):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive . </code></pre>
</div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_csv_file(file_path):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Print the contents of a CSV file in a human-readable format.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">        file_path (str): The path to the CSV file.</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'r'</span>, newline<span class="op">=</span><span class="st">''</span>) <span class="im">as</span> csv_file:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        csv_reader <span class="op">=</span> csv.reader(csv_file)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> row <span class="kw">in</span> csv_reader:</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">','</span>.join(row))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>data_to_write <span class="op">=</span> [</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Name'</span>, <span class="st">'Age'</span>, <span class="st">'Occupation'</span>],</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'John'</span>, <span class="st">'25'</span>, <span class="st">'Engineer'</span>],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Jane'</span>, <span class="st">'30'</span>, <span class="st">'Doctor'</span>],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Bob'</span>, <span class="st">'28'</span>, <span class="st">'Teacher'</span>],</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Alice'</span>, <span class="st">'22'</span>, <span class="st">'Student'</span>]</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'example.csv'</span>, <span class="st">'w'</span>, newline<span class="op">=</span><span class="st">''</span>) <span class="im">as</span> csv_file:</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    csv_writer <span class="op">=</span> csv.writer(csv_file)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    csv_writer.writerows(data_to_write)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'example.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Name,Age,Occupation
John,25,Engineer
Jane,30,Doctor
Bob,28,Teacher
Alice,22,Student</code></pre>
</div>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_containing_span(spans):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    This function takes a list of spans, where each span is represented</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    as a list containing a label and a span (interval). It resolves overlaps</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    by selecting the containing span, favoring the larger span in case of conflicts.</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">    spans (list of lists): A list of spans, where each span is represented</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">        as a list [label, span].</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">    list of lists: A list of resolved spans, where each span is a list</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">        [label, span], with conflicts resolved by selecting the containing span.</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort the replacements by the size of the spans in descending order</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    spans.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>].span_end <span class="op">-</span> x[<span class="dv">1</span>].span_start, reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize a list to keep track of intervals that have been replaced</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    resolved_spans <span class="op">=</span> []</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label, span <span class="kw">in</span> spans:</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        conflict <span class="op">=</span> <span class="va">False</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, existing_span <span class="kw">in</span> resolved_spans:</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>            existing_start <span class="op">=</span> existing_span.span_start</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            existing_end <span class="op">=</span> existing_span.span_end</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> (span.span_end <span class="op">&lt;=</span> existing_start <span class="kw">or</span> span.span_start <span class="op">&gt;=</span> existing_end):</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                conflict <span class="op">=</span> <span class="va">True</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> conflict:</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>            resolved_spans.append([label, span])</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resolved_spans</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-19" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>spans <span class="op">=</span> [ </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>     [<span class="st">'Label1'</span>, Span(<span class="dv">2</span>, <span class="dv">8</span>)],</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>     [<span class="st">'Label2'</span>, Span(<span class="dv">5</span>, <span class="dv">8</span>)]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a> ]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>resolved_spans <span class="op">=</span> select_containing_span(spans)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, span <span class="kw">in</span> resolved_spans:</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Label: </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">, Span: </span><span class="sc">{</span>span<span class="sc">.</span>span_start<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>span<span class="sc">.</span>span_end<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label: Label1, Span: 2-8</code></pre>
</div>
</div>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> replace_spans(spans_table, paths_table, session):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    This function takes tables a spans tables and path table for the files paths,</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    it generate queries for the tables, executes the queries using the given session, processes the results, </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    and replaces specific spans in a text with the corresponding labels, it first</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    resolve spans overlapping conflicts for each giving path.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    spans_table (str): A string representing the spans table to process, table columns are formated as (Label, Span, Path).</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    paths_table (str): A string representing the paths table to process, table columns are formated as (Path)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    session: the session in the spannerlog to run the queries at.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">    str: The adjusted text string with the new labels.</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a list of all the paths</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    paths <span class="op">=</span> session.run_commands(<span class="ss">f"?</span><span class="sc">{</span>paths_table<span class="sc">}</span><span class="ss">(Path)"</span>, print_results<span class="op">=</span><span class="va">False</span>, format_results<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    paths <span class="op">=</span> paths[<span class="dv">0</span>].values.tolist()</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> path_list <span class="kw">in</span> paths:</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> path_list[<span class="dv">0</span>]</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate a spans query for each path, the query will be formates as (Label, Span, Path)</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> magic_session.run_commands(<span class="ss">f'?</span><span class="sc">{</span>spans_table<span class="sc">}</span><span class="ss">(Label, Span, "</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">")'</span>, print_results<span class="op">=</span><span class="va">True</span>, format_results<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>]) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># replacments is list of lists where each list is a [Label, Span]</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        replacements <span class="op">=</span> results[<span class="dv">0</span>].values.tolist()</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">"</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>            adjusted_string <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Resolve spans conflicts</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>        resolved_replacements <span class="op">=</span> select_containing_span(replacements)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sort the resolved replacements by the starting index of each span in descending order</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        resolved_replacements.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>].span_start, reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># iterate over the resolved query results and replace the space with the corresponding label</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(resolved_replacements)):</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            replace_string, span <span class="op">=</span> resolved_replacements[i]</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>            replace_length <span class="op">=</span> <span class="bu">len</span>(replace_string)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>            adjusted_string <span class="op">=</span> adjusted_string[:span.span_start] <span class="op">+</span> replace_string <span class="op">+</span> adjusted_string[span.span_end:]</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">"</span>, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">file</span>.writelines(adjusted_string)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'example.txt'</span>, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.write(<span class="st">'The boy has novel coronavirus'</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>spannerlog new samplePaths(<span class="bu">str</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>spannerlog samplePaths(<span class="st">"example.txt"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>spannerlog new sampleMatches(<span class="bu">str</span>, span, <span class="bu">str</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>spannerlog sampleMatches(<span class="st">"Covid-19"</span>, [<span class="dv">12</span>,<span class="dv">29</span>), <span class="st">"example.txt"</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">'sampleMatches'</span>, <span class="st">'samplePaths'</span>, magic_session)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> value <span class="kw">in</span> read_from_file(<span class="st">"example.txt"</span>):</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'sampleMatches(Label, Span, "example.txt")':
  Label   |   Span
----------+----------
 Covid-19 | [12, 29)

The boy has Covid-19</code></pre>
</div>
</div>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_span_contained(span1, span2):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Checks if one span is contained within the other span and returns the smaller span if yes.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">        span1 (span)</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">        span2 (span)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">        span: span1 if contained within span2 or vice versa, or None if not contained.</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    start1, end1 <span class="op">=</span> span1.span_start, span1.span_end</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    start2, end2 <span class="op">=</span> span2.span_start, span2.span_end</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> start2 <span class="op">&lt;=</span> start1 <span class="kw">and</span> end1 <span class="op">&lt;=</span> end2:</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> span1</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> start1 <span class="op">&lt;=</span> start2 <span class="kw">and</span> end2 <span class="op">&lt;=</span> end1:</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> span2</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>magic_session.register(is_span_contained, <span class="st">"is_span_contained"</span>, in_rel<span class="op">=</span>[DataTypes.span, DataTypes.span], out_rel<span class="op">=</span>[DataTypes.span])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>span1 <span class="op">=</span> Span(<span class="dv">2</span>, <span class="dv">12</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>span2 <span class="op">=</span> Span(<span class="dv">8</span>, <span class="dv">9</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> span <span class="kw">in</span> is_span_contained(span1, span2):</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" Span: </span><span class="sc">{</span>span<span class="sc">.</span>span_start<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>span<span class="sc">.</span>span_end<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Span: 8-9</code></pre>
</div>
</div>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_relative_span(span1, span2):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes the relative position of the conatined span within the other span.</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">        span1 (Span): The first span object.</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">        span2 (Span): The second span object.</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Span: The new relative span of the contained one.</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">        None: If there's no span contained within the other.</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    start1, end1 <span class="op">=</span> span1.span_start, span1.span_end</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    start2, end2 <span class="op">=</span> span2.span_start, span2.span_end</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> start2 <span class="op">&lt;=</span> start1 <span class="kw">and</span> end1 <span class="op">&lt;=</span> end2:</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> Span(span1.span_start <span class="op">-</span> span2.span_start, span1.span_end <span class="op">-</span> span2.span_start)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> start1 <span class="op">&lt;=</span> start2 <span class="kw">and</span> end2 <span class="op">&lt;=</span> end1:</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> Span(span2.span_start <span class="op">-</span> span1.span_start, span2.span_end <span class="op">-</span> span1.span_start)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>magic_session.register(get_relative_span, <span class="st">"get_relative_span"</span>, in_rel<span class="op">=</span>[DataTypes.span, DataTypes.span], out_rel<span class="op">=</span>[DataTypes.span])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example </span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>span1 <span class="op">=</span> Span(<span class="dv">2</span>, <span class="dv">12</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>span2 <span class="op">=</span> Span(<span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> span <span class="kw">in</span> get_relative_span(span1, span2):</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" Span: </span><span class="sc">{</span>span<span class="sc">.</span>span_start<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>span<span class="sc">.</span>span_end<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Span: 0-3</code></pre>
</div>
</div>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sent_tokenization(text_path):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">    This function reads a text file, processes its content using spaCy's English language model,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">    tokenizing it into sentences and returns each individual sentence in the processed text using a generator.</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">        text_path (str): The path to the text file to be annotated.</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Individual sentences extracted from the input text.</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(text_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        contents <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(contents)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sentence <span class="kw">in</span> doc.sents:</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> sentence.text</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>magic_session.register(ie_function<span class="op">=</span>sent_tokenization, ie_function_name <span class="op">=</span> <span class="st">"sent_tokenization"</span>, in_rel<span class="op">=</span>[DataTypes.string], out_rel<span class="op">=</span>[DataTypes.string])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sentence <span class="kw">in</span> sent_tokenization(<span class="st">"sample1.txt"</span>):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(sentence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>patient presents to be tested for COVID-19 .
His family recently tested positive for COVID-19 .
COVID-19 results came back positive .</code></pre>
</div>
</div>
</section>
<section id="pipeline-input" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-input">Pipeline Input:</h3>
<p>The paths of the text files to be classified should be written in “files_paths.csv” file</p>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'files_paths.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>sample1.txt
sample2.txt
sample3.txt
sample4.txt
sample5.txt
sample6.txt
sample7.txt</code></pre>
</div>
</div>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"files_paths.csv"</span>, relation_name<span class="op">=</span><span class="st">"FilesPaths"</span>, delimiter<span class="op">=</span><span class="st">","</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The initial files contents:</p>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>FilesContent(Path, Content) <span class="op">&lt;-</span> FilesPaths(Path), read_from_file(Path) <span class="op">-&gt;</span> (Content)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
<p>Before we continue we have to do some pre processing to help ease the next stages, we will certain words in each list to it’s lemma forms, here a list of the words that we want to lemmatize</p>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'lemma_words.txt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>be
man
woman
have
do
emergency
epidemic
outbreak
crisis
breakout
pandemic
spread
confirm
person
patient
veteran
limit
reduce
factor
contact
case
lower
minimize
risk
chance
possibility
care
clean
desire
flight
trip
plan
reschedule
postpone
barrier</code></pre>
</div>
</div>
<p>We will define a helper method to do that:</p>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lemmatize_text(text_path, lemma_words_path):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">    This function reads a text file, lemmatizes its content using spaCy's English language model,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">    and replaces certain words with their lemmas the rest will remain the same. The updated text is then written back to the same file.</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">        text_path (str): The path to the text file to be lemmatized.</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">        lemma_words_path(str): The path that contains the list of words to be lemmatized</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">        str: The lemmatized text.</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a list of words to be lemmatized</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    lemma_words <span class="op">=</span> [line.strip() <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>lemma_words_path<span class="sc">}</span><span class="ss">"</span>) <span class="cf">if</span> line.strip()]</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(text_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        contents <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(contents)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    lemmatized_text <span class="op">=</span> <span class="st">""</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> token <span class="kw">in</span> doc:</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> token.lemma_ <span class="kw">in</span> lemma_words:</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>            lemmatized_text <span class="op">+=</span> token.lemma_</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> token.like_num:</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>            lemmatized_text <span class="op">+=</span> <span class="st">"like_num"</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>            lemmatized_text <span class="op">+=</span> token.text</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>        lemmatized_text <span class="op">+=</span> <span class="st">" "</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the lemmatized text back to the same file</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(text_path, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span>.writelines(lemmatized_text)</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lemmatized_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'example.txt'</span>, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.write(<span class="st">'The boy was sick'</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>lemmatized_text <span class="op">=</span> lemmatize_text(<span class="st">'example.txt'</span>, <span class="st">'lemma_words.txt'</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(lemmatized_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The boy be sick </code></pre>
</div>
</div>
<p>Iterate over the texts to lemmatize them</p>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'files_paths.csv'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a CSV reader object</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    csv_reader <span class="op">=</span> csv.reader(<span class="bu">file</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate through each row in the CSV file</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> csv_reader:</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> row[<span class="dv">0</span>]</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        lemmatize_text(path, <span class="st">'lemma_words.txt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we can see for example in sample2.txt, was has changed to be.</p>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
</section>
<section id="concept-tagger" class="level3">
<h3 class="anchored" data-anchor-id="concept-tagger"><a href="https://github.com/abchapman93/VA_COVID-19_NLP_BSV/blob/master/cov_bsv/knowledge_base/concept_tag_rules.py">Concept Tagger</a>:</h3>
<p>Concept tag rules, also known as pattern-based rules or custom rules, are a way to specify and define patterns that an NLP (Natural Language Processing) system should recognize within text data. These rules are used to identify specific concepts or entities within text documents. In the context of MedSpaCy and medical NLP, concept tag rules are often used to identify medical entities and concepts accurately.</p>
<p>In the orginal project they used the TargetRule class which defines a rule for identifying a specific concept or entity in text. each concept Target Rule looks like this:</p>
<p>TargetRule( literal=“coronavirus”, category=“COVID-19”, pattern=[{“LOWER”: {“REGEX”: “coronavirus|hcov|ncov$”}}], )</p>
<p><strong>Literal</strong> : This specifies the literal text or word that this rule is targeting.</p>
<p><strong>Category</strong> : This specifies the category or label associated with the identified entity.</p>
<p><strong>Pattern</strong> : This defines the pattern or conditions under which the entity should be recognized. It’s a list of dictionaries specifying conditions for token matching. These rules some times used lemma attribute or POS of each token. A documentation can be found at : https://spacy.io/usage/rule-based-matching.</p>
<p>Instead what we did is to define regex patterns, we have added these pattern in concept_target_rules.csv file, there are two types of these patterns lemma and pos, that we will implement each later on. Each rule in the csv file is like this : regexPattern, label, type</p>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'concept_tags_rules.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(?i)(?:hcov|covid(?:(?:-)?(?:\s)?19|10)?|2019-cov|cov2|ncov-19|covd 19|no-cov|sars cov),COVID-19,lemma
(?i)(?:coivid|(?:novel )?corona(?:virus)?(?: (?:20)?19)?|sars(?:\s)?(?:-)?(?:\s)?cov(?:id)?(?:-)?(?:2|19)),COVID-19,lemma
(?i)(?:\+(?: ve)?|\(\+\)|positive|\bpos\b|active|confirmed),positive,lemma
(?i)(?:pneum(?:onia)?|pna|hypoxia|septic shoc|ards\(?(?:(?:[12])/2)\)?|(?:hypoxemic|acute|severe)? resp(?:iratory)? failure(?:\(?(?:[12]/2)\)?)?)",associated_diagnosis,lemma
(?i)(?:(?:diagnos(?:is|ed)|dx(?:\.)?)(?:of|with)?),diagnosis,lemma
(?i)(?:^screen),screening,lemma
(?i)(?:in contact with|any one|co-worker|at work|(?:the|a)(?:wo)?man|(?:another|a) (?:pt|patient|pt\.)),other_experiencer,lemma
(?i)(?:patient|pt(?:\.)?|vt|veteran),patient,lemma
(?i)(?:like_num (?:days|day|weeks|week|months|month) (?:ago|prior)),timesx,lemma
(?i)(?:(?:antibody|antibodies|ab) test),antibody test,lemma
(?i)(?:(?:coronavirus|hcovs?|ncovs?|covs?)(?:\s)?(?:-)?(?:\s)?(?: infection)?(?: strain)?(?:\s)?(?:229(?:e)?|oc(?:-)?(?:43)?|o43|0c43|43|nl(?:16(?:3|5))?|hku(?:t|-)?1|hkui|emc|63)),OTHER_CORONAVIRUS,lemma
(?i)(?:(?:229(?:e)?|oc(?:-)?(?:43)?|o43|0c43|43|nl(?:16(?:3|5))?|hku(?:t|-)?1|hkui|emc|63) (?:coronavirus|hcovs?|ncovs?|covs?)),OTHER_CORONAVIRUS,lemma
(?i)(?:non(?:\s)?(?:-)?(?:\s)?(?:novel|covid|ncovid|covid-19)(?: coronavirus)?|other coronavirus),OTHER_CORONAVIRUS,lemma
(?i)(?:wife|husband|spouse|family|member|girlfriend|boyfriend|mother|father|nephew|niece|grandparent|grandparents|granddaughter|relative|relatives|caregiver),family,pos
(?i)(?:grandchild|grandson|cousin|grandmother|grandfather|parent|son|daughter|mom|dad|brother|sister|aunt|uncle|child|children|sibling|siblings),family,pos
(?i)(?:someone|somebody|person|anyone|anybody|people|individual|individuals|teacher|anybody|employees|employer|customer|client|residents),other_experiencer,pos
(?i)(?:resident|pts|patients|coworker|coworkers|workers|colleague|captain|captains|pilot|pilots|sailor|sailors|meeting),other_experiencer,pos
(?i)(?:boyfriend|persons|person|church|convention|guest|party|attendee|conference|roommate|friend|friends|coach|player|neighbor|manager|boss),other_experiencer,pos
(?i)(?:cashier|landlord|worked|works|^mate|nobody|mates|housemate|housemates|hotel|soldier|airport|tsa|lady|ladies|lobby|staffer|staffers),other_experiencer,pos</code></pre>
</div>
</div>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"concept_tags_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"ConceptTagRules"</span>, delimiter<span class="op">=</span><span class="st">","</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lemma-rules" class="level3">
<h3 class="anchored" data-anchor-id="lemma-rules">Lemma Rules:</h3>
<p>Lemma rules are rules that used the attribute _lemma of each token in the NLP, we already lemmatized the texts, so now we can create a regex patterns for that.</p>
<p>Example for a lemma rule from the original NLP:</p>
<pre><code>    TargetRule(
        "results positive",
        "positive",
        pattern=[
            {"LOWER": "results"},
            {"LEMMA": "be", "OP": "?"},
            {"LOWER": {"IN": ["pos", "positive"]}},
        ],
    ),</code></pre>
<p>We used the py_rgx_span to capture the patterns, and will use the spans later on in replace_spans that will replace each span with the correct label</p>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>LemmaMatches(Label, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), ConceptTagRules(Pattern, Label, <span class="st">"lemma"</span>), py_rgx_span(Content, Pattern) <span class="op">-&gt;</span> (Span)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before:</p>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># replace the matches with the correct label</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">"LemmaMatches"</span>, <span class="st">"FilesPaths"</span>, magic_session)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'LemmaMatches(Label, Span, "sample1.txt")':
  Label   |    Span
----------+------------
 COVID-19 |  [34, 42)
 COVID-19 |  [85, 93)
 COVID-19 | [96, 104)
 positive | [123, 131)
 positive |  [72, 80)
 patient  |   [0, 7)

printing results for query 'LemmaMatches(Label, Span, "sample2.txt")':
  Label   |   Span
----------+----------
 COVID-19 | [26, 34)
 positive | [48, 56)
 patient  | [4, 11)

printing results for query 'LemmaMatches(Label, Span, "sample3.txt")':
   Label   |   Span
-----------+----------
 COVID-19  | [58, 66)
 diagnosis | [37, 46)

printing results for query 'LemmaMatches(Label, Span, "sample4.txt")':
  Label   |  Span
----------+---------
 COVID-19 | [4, 12)

printing results for query 'LemmaMatches(Label, Span, "sample5.txt")':
  Label   |  Span
----------+---------
 COVID-19 | [9, 17)
 positive | [0, 8)

printing results for query 'LemmaMatches(Label, Span, "sample6.txt")':
  Label   |   Span
----------+----------
 COVID-19 | [26, 34)
 patient  | [4, 11)

printing results for query 'LemmaMatches(Label, Span, "sample7.txt")':
[]
</code></pre>
</div>
</div>
<p>After: As we can see for example in the sample1.txt, every other covid-19 name was changed to COVID-19.</p>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
</section>
<section id="pos-rules" class="level3">
<h3 class="anchored" data-anchor-id="pos-rules">POS Rules:</h3>
<p>As we mentioned above these rules used the POS attribute of each token, there were a small number of rules so we only used this to the tokens we needed. Example of the a rule from the original NLP:</p>
<pre><code>    TargetRule(
        "other experiencer",
        category="other_experiencer",
        pattern=[
            {
                "POS": {"IN": ["NOUN", "PROPN", "PRON", "ADJ"]},
                "LOWER": {
                    "IN": [
                        "someone",
                        "somebody",
                        "person",
                        "anyone",
                        "anybody",
                    ]
                },
            }
        ],
    ),</code></pre>
<p>The patterns we’ve defined will match words listed under “IN”, We specifically capture words if their Part-of-Speech (POS) falls into one of the categories: [“NOUN”, “PROPN”, “PRON”, “ADJ”]. To accomplish this, two functions are employed: the first function determines the POS of each token, and the second one, py_rgx_span, captures the predefined patterns. After matching words, We confirm the accurate POS tags of the matched words using spans.</p>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annotate_text_with_pos(text_path):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co">    This function reads a text file, processes its content using spaCy's English language model,</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">    and returns a tuple of (POS, Span) for each token if it's one of NOUN|PROPN|PRON|ADJ</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">    otherwise an empty tuple will be returned</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">        text_path (str): The path to the text file to be annotated.</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple(str, Span): The POS of the token and it's span</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(text_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        contents <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(contents)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> token <span class="kw">in</span> doc:</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> token.pos_ <span class="kw">in</span> [<span class="st">"NOUN"</span>, <span class="st">"PROPN"</span>, <span class="st">"PRON"</span>, <span class="st">"ADJ"</span>]:</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> token.pos_, Span(token.idx, token.idx <span class="op">+</span> <span class="bu">len</span>(token.text))</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> <span class="bu">tuple</span>()</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>magic_session.register(ie_function<span class="op">=</span>annotate_text_with_pos, ie_function_name <span class="op">=</span> <span class="st">"annotate_text_with_pos"</span>, in_rel<span class="op">=</span>[DataTypes.string], out_rel<span class="op">=</span>[DataTypes.string, DataTypes.span])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'example.txt'</span>, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.write(<span class="st">'sick boy'</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> POS, span <span class="kw">in</span> annotate_text_with_pos(<span class="st">'example.txt'</span>):</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>POS<span class="sc">}</span><span class="ss">, (</span><span class="sc">{</span>span<span class="sc">.</span>span_start<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>span<span class="sc">.</span>span_end<span class="sc">}</span><span class="ss">)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ADJ, (0,4)
NOUN, (5,8)</code></pre>
</div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>POSTable(POS, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), annotate_text_with_pos(Path) <span class="op">-&gt;</span> (POS, Span)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>?POSTable(POS, Span, Path)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>POSMatches(Label, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), ConceptTagRules(Pattern, Label, <span class="st">"pos"</span>), py_rgx_span(Content, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>?POSMatches(Label, Span, Path)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>POSRuleMatches(Label, Span, Path) <span class="op">&lt;-</span> POSTable(POS, Span, Path), POSMatches(Label, Span, Path)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>?POSRuleMatches(Label, Span, Path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'POSTable(POS, Span, Path)':
  POS  |    Span    |    Path
-------+------------+-------------
  ADJ  |   [0, 7)   | sample1.txt
  ADJ  | [123, 131) | sample1.txt
  ADJ  |  [72, 80)  | sample1.txt
 NOUN  | [105, 112) | sample1.txt
 NOUN  |  [49, 55)  | sample1.txt
 NOUN  |  [8, 16)   | sample1.txt
 PRON  |  [45, 48)  | sample1.txt
 PROPN |  [34, 42)  | sample1.txt
 PROPN |  [85, 93)  | sample1.txt
 PROPN | [96, 104)  | sample1.txt
  ADJ  |  [48, 56)  | sample2.txt
 NOUN  |  [37, 44)  | sample2.txt
 NOUN  |  [4, 11)   | sample2.txt
 PROPN |  [26, 34)  | sample2.txt
 NOUN  |  [0, 12)   | sample3.txt
 PROPN |  [15, 23)  | sample3.txt
 PROPN |  [47, 55)  | sample3.txt
 PROPN |  [58, 66)  | sample3.txt
 PROPN |  [67, 75)  | sample3.txt
 NOUN  |  [13, 22)  | sample4.txt
 PROPN |   [0, 3)   | sample4.txt
 PROPN |  [4, 12)   | sample4.txt
  ADJ  |   [0, 8)   | sample5.txt
 NOUN  |  [18, 28)  | sample5.txt
 PROPN |  [9, 17)   | sample5.txt
 NOUN  |  [4, 11)   | sample6.txt
 PROPN |  [26, 34)  | sample6.txt
  ADJ  |   [0, 8)   | sample7.txt
  ADJ  |  [36, 43)  | sample7.txt
 NOUN  |  [21, 27)  | sample7.txt
 NOUN  |  [44, 54)  | sample7.txt
 NOUN  |  [59, 68)  | sample7.txt
 NOUN  |  [69, 80)  | sample7.txt
 NOUN  |  [9, 20)   | sample7.txt

printing results for query 'POSMatches(Label, Span, Path)':
  Label  |   Span   |    Path
---------+----------+-------------
 family  | [49, 55) | sample1.txt

printing results for query 'POSRuleMatches(Label, Span, Path)':
  Label  |   Span   |    Path
---------+----------+-------------
 family  | [49, 55) | sample1.txt
</code></pre>
</div>
</div>
<p>Before:</p>
<div id="cell-57" class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># replace the matches with the correct label</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">"POSRuleMatches"</span>, <span class="st">"FilesPaths"</span>, magic_session)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'POSRuleMatches(Label, Span, "sample1.txt")':
  Label  |   Span
---------+----------
 family  | [49, 55)

printing results for query 'POSRuleMatches(Label, Span, "sample2.txt")':
[]

printing results for query 'POSRuleMatches(Label, Span, "sample3.txt")':
[]

printing results for query 'POSRuleMatches(Label, Span, "sample4.txt")':
[]

printing results for query 'POSRuleMatches(Label, Span, "sample5.txt")':
[]

printing results for query 'POSRuleMatches(Label, Span, "sample6.txt")':
[]

printing results for query 'POSRuleMatches(Label, Span, "sample7.txt")':
[]
</code></pre>
</div>
</div>
<p>After: As we can see for example in sample1.txt, wife has changed to family.</p>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
</section>
<section id="target-rules" class="level3">
<h3 class="anchored" data-anchor-id="target-rules"><a href="https://github.com/abchapman93/VA_COVID-19_NLP_BSV/blob/master/cov_bsv/knowledge_base/target_rules.py">Target Rules</a>:</h3>
<p>These rules used the label that was assigned through the concept tagger, to capture some more complex patterns and assign a label for them inorder to decremnt the cases of false positive. Each rule look like this:</p>
<pre><code>    TargetRule(
        literal="coronavirus screening",
        category="IGNORE",
        pattern=[
            {"_": {"concept_tag": "COVID-19"}},
            {"LOWER": {"IN": ["screen", "screening", "screenings"]}},
        ],
    ),</code></pre>
<p>Since we replaced the spans we found with the corresponding label we didn’t need the concept_tag attribute of the token/span.</p>
<p><strong>Literal</strong> : This specifies the literal text or word that this rule is targeting.</p>
<p><strong>Category</strong> : This specifies the category or label associated with the identified entity.</p>
<p><strong>Pattern</strong> : This defines the pattern or conditions under which the entity should be recognized. It’s a list of dictionaries specifying conditions for token matching. These rules some times used lemma attribute or POS of each token. A documentation can be found at : https://spacy.io/usage/rule-based-matching.</p>
<p>Similar to the concept tag apporach we defined regex patterns, we have added these pattern in target_rules.csv file Each rule in the csv file is like this : regexPattern, label</p>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'target_rules.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(?i)(?:COVID-19 positive (?:unit|floor)|positive COVID-19 (?:unit|floor|exposure)),COVID-19
(?i)(?:known(?: positive)? COVID-19(?: positive)? (?:exposure|contact)),COVID-19
(?i)(?:COVID-19 positive screening|positive COVID-19 screening|screening COVID-19 positive|screening positive COVID-19),positive coronavirus screening
(?i)(?:diagnosis : COVID-19 (?:test|screening)),COVID-19
(?i)(?:COVID-19 screening),coronavirus screening
(?i)(?:active COVID-19 precaution|droplet isolation precaution|positive for (?:flu|influenza)|(?:the|a) positive case|results are confirm),1 2 3
(?i)(?:exposed to positive|[ ] COVID-19|age like_num(?: )?\+|(?:return|back) to work|COVID-19 infection rate),1 2 3
(?i)(?:COVID-19 (?:restriction|emergency|epidemic|outbreak|crisis|breakout|pandemic|spread|screening)|droplet precaution),1 2
(?i)(?:contact precautions|positive (?:flu|influenza)|positive (?:patient|person)|confirm (?:with|w/(?:/)?|w)|(?:the|positive) case),1 2
(?i)(?:results confirm|(?:neg|pos)\S+ pressure|positive (?:attitude|feedback|serology)|COVID-19 (guidelines|rate)),1 2
(?i)(?:has the patient been diagnosed (?:with|w/(?:/)?|w)),1 2 3 4 5 6
(?i)(?:has patient been diagnosed (?:with|w/(?:/)?|w)),1 2 3 4 5
(?i)((?:person|patient) with confirm COVID-19),1 2 3 4
(?i)(?:COVID-19 positive (?:tested )?other_experiencer),COVID-19
(?i)(?:in order to decrease the spread of the COVID-19 infection),1 2 3 4 5 6 7 8 9 10
(?i)(?:COVID-19 positive (?:patient|person|people|veteran)),OTHER_PERSON
(?i)(?:positive COVID-19 (?:tested )?other_experiencer),COVID-19
(?i)(?:(?:(?:contact|exposure) (?:with|to)? )?positive COVID-19 (?:patient|person|veteran)),OTHER_PERSON
(?i)(?:(?:patient|person) (?:who|that) test (?:positive|confirm) for COVID-19),OTHER_PERSON
(?i)(ref : not detected|history of present illness|does not know|but|therefore|flu|metapneumovirus|;),&lt;IGNORE&gt;</code></pre>
</div>
</div>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"target_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"TargetTagRules"</span>, delimiter<span class="op">=</span><span class="st">","</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-64" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>TargetTagMatches(Label, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), TargetTagRules(Pattern, Label), py_rgx_span(Content, Pattern) <span class="op">-&gt;</span> (Span)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before:</p>
<div id="cell-66" class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">"TargetTagMatches"</span>, <span class="st">"FilesPaths"</span>, magic_session)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'TargetTagMatches(Label, Span, "sample1.txt")':
[]

printing results for query 'TargetTagMatches(Label, Span, "sample2.txt")':
[]

printing results for query 'TargetTagMatches(Label, Span, "sample3.txt")':
[]

printing results for query 'TargetTagMatches(Label, Span, "sample4.txt")':
[]

printing results for query 'TargetTagMatches(Label, Span, "sample5.txt")':
[]

printing results for query 'TargetTagMatches(Label, Span, "sample6.txt")':
[]

printing results for query 'TargetTagMatches(Label, Span, "sample7.txt")':
[]
</code></pre>
</div>
</div>
<p>After: As we can see in sample6.txt, the covid positive exposure has changed to covid, in order to not give false positive.</p>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
</section>
<section id="section-rules" class="level3">
<h3 class="anchored" data-anchor-id="section-rules"><a href="https://github.com/abchapman93/VA_COVID-19_NLP_BSV/blob/master/cov_bsv/knowledge_base/section_rules.py">Section Rules</a>:</h3>
<p>Here, we’ll add a section detection component that defines rules for detecting sections titles, which usually appear before a semicolon. Section rules are utilized to identify specific section names, enabling the separation of text into different parts. Entities occurring in certain sections are considered positive.</p>
<p>In the original project, the SectionRule class was used to define rules for identifying specific section text. Each SectionRule has the following structure</p>
<pre><code>  SectionRule(category="problem_list", literal="Active Problem List:"),
  SectionRule(category="problem_list", literal="Current Problems:"),</code></pre>
<p><strong>Literal</strong> : This specifies the literal section text or word that this rule is targeting.</p>
<p><strong>Category</strong> : This specifies the section category associated with the identified section.</p>
<p>Similar to the approach used in the concept tagger stage, regex patterns were derived from these literals, and these patterns are stored in the ‘section_target_rules.csv’ file and are used to match section texts and replace them with their appropriate category.</p>
<p>Each rule in the CSV file follows this format: regexPattern, sectionLabel</p>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'section_rules.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(?i)(?:Lab results :),labs :
(?i)(?:Addendum :),addendum :
(?i)(?:(?:ALLERGIC REACTIONS|ALLERGIES) :),allergies :
(?i)(?:(?:CC|Chief Complaint) :),chief_complaint :
(?i)(?:COMMENTS :),comments :
(?i)(?:(?:(?:ADMISSION )?DIAGNOSES|Diagnosis|Primary Diagnosis|Primary|Secondary(?: (?:Diagnoses|Diagnosis))) :),diagnoses :
(?i)(?:(?:Brief Hospital Course|CONCISE SUMMARY OF HOSPITAL COURSE BY ISSUE/SYSTEM|HOSPITAL COURSE|SUMMARY OF HOSPITAL COURSE) :),hospital_course :
(?i)(?:(?:Imaging|MRI|INTERPRETATION|Radiology) :),imaging :
(?i)(?:(?:ADMISSION LABS|Discharge Labs|ECHO|Findings|INDICATION|Labs|Micro|Microbiology|Studies|Pertinent Results) :),labs_and_studies :
(?i)(?:(?:ACTIVE MEDICATIONS(?: LIST)|ADMISSION MEDICATIONS|CURRENT MEDICATIONS|DISCHARGE MEDICATIONS|HOME MEDICATIONS|MEDICATIONS) :),medications :
(?i)(?:(?:MEDICATIONS AT HOME|MEDICATIONS LIST|MEDICATIONS ON ADMISSION|MEDICATIONS ON DISCHARGE|MEDICATIONS ON TRANSFER|MEDICATIONS PRIOR TO ADMISSION) :),medications :
(?i)(?:Neuro :),neurological :
(?i)(?:(?:A/P|MEDICATIONS LIST|ASSESSMENT/PLAN|ASSESSMENT|Clinical Impression|DISCHARGE DIAGNOSES|DISCHARGE DIAGNOSIS) :),observation_and_plan :
(?i)(?:(?:Discharge Condition|Discharge Disposition|FINAL DIAGNOSES|FINAL DIAGNOSIS|IMPRESSION|Impression and Plan|Impression and Recommendation) :),observation_and_plan :
(?i)(?:(?:Facility|Service) :),other :
(?i)(?:(?:Current Medical Problems|History of Chronic Illness|MHx|PAST HISTORY|PAST MEDICAL Hx|PAST SURGICAL HISTORY|PMH|PMHx|PAST MEDICAL HISTORY|UNDERLYING MEDICAL CONDITION) :),past_medical_history :
(?i)(?:(?:Education|Patient Education|DISCHARGE INSTRUCTIONS/FOLLOWUP|DISCHARGE INSTRUCTIONS|Followup Instructions) :),patient_education :
(?i)(?:(?:PE|PHYSICAL EXAM|PHYSICAL EXAMINATION) :),physical_exam :
(?i)(?:(?:Active Problem List|Current Problems|Medical Problems|PROBLEM LIST) :),problem_list :
(?i)(?:REASON FOR THIS EXAMINATION :),reason_for_examination :
(?i)(?:(?:Electronic Signature|Signed electronically by) :),signature :
(?i)(?:(?:PMHSx|PSH|SH|Sexual History:|Social History) :),social_history :</code></pre>
</div>
</div>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"section_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"SectionRules"</span>, delimiter<span class="op">=</span><span class="st">","</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>SectionRulesMatches(Label, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), SectionRules(Pattern, Label), py_rgx_span(Content, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>?SectionRulesMatches(Label, Span, Path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'SectionRulesMatches(Label, Span, Path)':
[]
</code></pre>
</div>
</div>
<p>Before:</p>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">"SectionRulesMatches"</span>, <span class="st">"FilesPaths"</span>, magic_session)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'SectionRulesMatches(Label, Span, "sample1.txt")':
[]

printing results for query 'SectionRulesMatches(Label, Span, "sample2.txt")':
[]

printing results for query 'SectionRulesMatches(Label, Span, "sample3.txt")':
[]

printing results for query 'SectionRulesMatches(Label, Span, "sample4.txt")':
[]

printing results for query 'SectionRulesMatches(Label, Span, "sample5.txt")':
[]

printing results for query 'SectionRulesMatches(Label, Span, "sample6.txt")':
[]

printing results for query 'SectionRulesMatches(Label, Span, "sample7.txt")':
[]
</code></pre>
</div>
</div>
<p>After: As we can see in sample 3, current problems has changed to problems_list.</p>
<div id="cell-78" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>?FilesContent(Path, Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'FilesContent(Path, Content)':
    Path     |                                                                Content
-------------+---------------------------------------------------------------------------------------------------------------------------------------
 sample1.txt | patient presents to be tested for COVID-19 . His family recently tested positive for COVID-19 . COVID-19 results came back positive .
 sample2.txt |                                      The patient be tested for COVID-19 . Results be positive .
 sample3.txt |                              problem_list : like_num . associated_diagnosis like_num . COVID-19 like_num
 sample4.txt |                                                       neg COVID-19 education .
 sample5.txt |                                                    positive COVID-19 precaution .
 sample6.txt |                                                 The patient have reported COVID-19 .
 sample7.txt |                          Elevated cholesterol levels require further assessment and lifestyle adjustments .
</code></pre>
</div>
</div>
</section>
<section id="attribute-assertion" class="level3">
<h3 class="anchored" data-anchor-id="attribute-assertion">Attribute Assertion:</h3>
<p>Next, we will explore how to assert attributes indicating whether a mention of COVID-19 is positive or not. In our project, we have created a table named ‘CovidAttributes’ that contains all attributes for each COVID-19 mention. This table will be used for classifying documents.</p>
<div id="cell-80" class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Here, we employ a pattern to identify entities present in specific sections and mark them as positive,</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co">#and adding them to the 'CovidAttributes' table.</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>pattern <span class="op">=</span> <span class="st">"(?i)(?:diagnoses :|observation_and_plan :|past_medical_history :|problem_list :)(?:(?!labs :|addendum :|allergies :|chief_complaint :|comments :|family_history :|hospital_course :|imaging :|labs_and_studies :|medications :|neurological :|other :|patient_education :|physical_exam :|reason_for_examination :|signature :|social_history :).)*"</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>new SectionRulesAttribute(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>SectionRulesAttribute(pattern, <span class="st">"positive"</span>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>SectionMatches(Path, Span, CovidAttribute) <span class="op">&lt;-</span> FilesContent(Path, Content), SectionRulesAttribute(Pattern, CovidAttribute), py_rgx_span(Content, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>?SectionMatches(Path, Span, CovidAttribute)</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>CovidMatches(Path, Span) <span class="op">&lt;-</span> FilesContent(Path, Content), py_rgx_span(Content, <span class="st">"COVID-19"</span>) <span class="op">-&gt;</span> (Span)</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>?CovidMatches(Path, Span)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'SectionMatches(Path, Span, CovidAttribute)':
    Path     |  Span   |  CovidAttribute
-------------+---------+------------------
 sample3.txt | [0, 76) |     positive

printing results for query 'CovidMatches(Path, Span)':
    Path     |   Span
-------------+-----------
 sample1.txt | [34, 42)
 sample1.txt | [85, 93)
 sample1.txt | [96, 104)
 sample2.txt | [26, 34)
 sample3.txt | [58, 66)
 sample4.txt |  [4, 12)
 sample5.txt |  [9, 17)
 sample6.txt | [26, 34)
</code></pre>
</div>
</div>
<div id="cell-81" class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>SectionCovidAttributes(Path, CovidSpan, CovidAttribute) <span class="op">&lt;-</span> SectionMatches(Path, Span1, CovidAttribute), CovidMatches(Path, Span2), is_span_contained(Span1, Span2) <span class="op">-&gt;</span> (CovidSpan)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>?SectionCovidAttributes(Path, CovidSpan, CovidAttribute)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'SectionCovidAttributes(Path, CovidSpan, CovidAttribute)':
    Path     |  CovidSpan  |  CovidAttribute
-------------+-------------+------------------
 sample3.txt |  [58, 66)   |     positive
</code></pre>
</div>
</div>
</section>
<section id="tokenizing-the-text-into-sentences" class="level3">
<h3 class="anchored" data-anchor-id="tokenizing-the-text-into-sentences">Tokenizing the Text into Sentences:</h3>
<p>In the subsequent stages, where attributes are assigned to COVID-19 mentions, a departure from the previous stages occurs. Here, patterns are no longer applied to the entire text, instead, they are applied at the sentence level, since the attributes of COVID-19 mentions are typically determined by the context of the sentence in which they appear. This means the text is processed and tokenized into sentences using spaCy’s English language model. This process is accomplished through the use of ie functions and relations.</p>
<div id="cell-83" class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Sentences of the text</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>Sents(Path, Sent) <span class="op">&lt;-</span> FilesPaths(Path), sent_tokenization(Path) <span class="op">-&gt;</span> (Sent)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>?Sents(Path, Sent)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SentSpan is the span of the sentence in the text</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>SentSpans(Path, Sent, SentSpan) <span class="op">&lt;-</span> FilesContent(Path, Content), Sents(Path, Sent), py_rgx_span(Content, Sent) <span class="op">-&gt;</span> (SentSpan)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>?SentSpans(Path, Sent, SentSpan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'Sents(Path, Sent)':
    Path     |                                        Sent
-------------+------------------------------------------------------------------------------------
 sample1.txt |                       COVID-19 results came back positive .
 sample1.txt |                 His family recently tested positive for COVID-19 .
 sample1.txt |                    patient presents to be tested for COVID-19 .
 sample2.txt |                               Results be positive .
 sample2.txt |                        The patient be tested for COVID-19 .
 sample3.txt |                                 COVID-19 like_num
 sample3.txt |                                associated_diagnosis
 sample3.txt |                                     like_num .
 sample3.txt |                             problem_list : like_num .
 sample4.txt |                              neg COVID-19 education .
 sample5.txt |                           positive COVID-19 precaution .
 sample6.txt |                        The patient have reported COVID-19 .
 sample7.txt | Elevated cholesterol levels require further assessment and lifestyle adjustments .

printing results for query 'SentSpans(Path, Sent, SentSpan)':
    Path     |                                        Sent                                        |  SentSpan
-------------+------------------------------------------------------------------------------------+------------
 sample1.txt |                       COVID-19 results came back positive .                        | [96, 133)
 sample1.txt |                 His family recently tested positive for COVID-19 .                 |  [45, 95)
 sample1.txt |                    patient presents to be tested for COVID-19 .                    |  [0, 44)
 sample2.txt |                               Results be positive .                                |  [37, 58)
 sample2.txt |                        The patient be tested for COVID-19 .                        |  [0, 36)
 sample3.txt |                                 COVID-19 like_num                                  |  [58, 75)
 sample3.txt |                                associated_diagnosis                                |  [26, 46)
 sample3.txt |                                     like_num .                                     |  [15, 25)
 sample3.txt |                                     like_num .                                     |  [47, 57)
 sample3.txt |                             problem_list : like_num .                              |  [0, 25)
 sample4.txt |                              neg COVID-19 education .                              |  [0, 24)
 sample5.txt |                           positive COVID-19 precaution .                           |  [0, 30)
 sample6.txt |                        The patient have reported COVID-19 .                        |  [0, 36)
 sample7.txt | Elevated cholesterol levels require further assessment and lifestyle adjustments . |  [0, 82)
</code></pre>
</div>
</div>
<div id="cell-84" class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, CovidAttribute, Sent) <span class="op">&lt;-</span> SectionCovidAttributes(Path, AbsCovidSpan, CovidAttribute),<span class="op">\</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>SentSpans(Path, Sent, SentSpan) ,get_relative_span(AbsCovidSpan, SentSpan) <span class="op">-&gt;</span> (CovidSpan)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>?CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)':
    Path     |  CovidSpan  |  CovidAttribute  |       Sent
-------------+-------------+------------------+-------------------
 sample3.txt |   [0, 8)    |     positive     | COVID-19 like_num
</code></pre>
</div>
</div>
</section>
<section id="context-rules" class="level3">
<h3 class="anchored" data-anchor-id="context-rules"><a href="https://github.com/abchapman93/VA_COVID-19_NLP_BSV/blob/master/cov_bsv/knowledge_base/context_rules.py">Context Rules</a>:</h3>
<p>These rules assign an attribute for each COVID-19 label based on the context, these attributes will be used later to classify each text.</p>
<p>Example for this rule is:</p>
<pre><code>ConTextRule(
    literal="Not Detected",
    category="NEGATED_EXISTENCE",
    direction="BACKWARD",
    pattern=[
        {"LOWER": {"IN": ["not", "non"]}},
        {"IS_SPACE": True, "OP": "*"},
        {"TEXT": "-", "OP": "?"},
        {"LOWER": {"REGEX": "detecte?d"}},
    ],
    allowed_types={"COVID-19"},
),</code></pre>
<p><strong>direction</strong> specify if the allowed_types should be before or after the pattern, <strong>allowed_types</strong> specify on what labels should this rule be applied on</p>
<div id="cell-86" class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'context_rules.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(?i)(?:positive COVID-19|COVID-19 (?:\([^)]*\)) (?:positive|detected)|COVID-19(?: positive)? associated_diagnosis)#positive
(?i)(?:COVID-19 status : positive)#positive
(?i)(?:associated_diagnosis COVID-19|associated_diagnosis (?:with|w|w//|from) (?:associated_diagnosis )?COVID-19)#positive
(?i)(?:COVID-19 positive(?: patient| precaution)?|associated_diagnosis (?:due|secondary) to COVID-19)#positive
(?i)(?:(?:current|recent) COVID-19 diagnosis)#positive
(?i)(?:COVID-19 (?:- )?related (?:admission|associated_diagnosis)|admitted (?:due to|(?:with|w|w/)) COVID-19)#positive
(?i)(?:COVID-19 infection|b34(?:\.)?2|b97.29|u07.1)#positive
(?i)(?:COVID-19 eval(?:uation)?|(?:positive )? COVID-19 symptoms|rule out COVID-19)#uncertain
(?i)(?:patient (?:do )?have COVID-19)#positive
(?i)(?:diagnosis : COVID-19(?: (?:test|screen)(?:ing|ed|s)? positive)?(?: positive)?)#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:not|non) (?:- )?detecte?d)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,1} negative screening|negative screening(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,2} : negative)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:not be|none) detected)#negated
(?i)(?:free from(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? not (?:be )?tested)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,4} not indicated)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? NEGATIVE NEG)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,3} negative test)#negated
(?i)(?:negative test(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#negated
(?i)(?:without any(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#negated
(?i)(?:denie(?:s|d)(?: any| travel)?(?: (?!&lt;IGNORE&gt;)\S+){0,9} COVID-19)#negated
(?i)(?:no (?:evidence(?: of)?|(?:hx|-hx|history) of|diagnosis (?:of)?)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:no(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#negated
(?i)(?:no (?:positive|one|residents|confirm case|contact(?: w/?(?:ith)?$))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? no confirm case)#negated
(?i)(?:(?:no|n't) (?:be )? confirm(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#negated
(?i)(?:(?:no known|not have)(?: (?!&lt;IGNORE&gt;)\S+){0,4} COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:answer(?:ed|s|ing)? (?:no|negative|neg)|negative))#negated
(?i)(?:(?:answer(?:ed|s|ing)? (?:no|negative|neg)|(?:neg|negative)(?: for)?)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:not positive(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? not positive)#negated
(?i)(?:excluded(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,3} excluded)#negated
(?i)(?:no risk factor for(?: (?!&lt;IGNORE&gt;)\S+){0,4} COVID-19)#uncertain
(?i)(?:negative screening(?: for)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? screening (?:negative|neg))#negated
(?i)(?:(?:screening (?:negative|neg) for|do (?:not|n't) have (?:any )?(?:signs|symptoms|ss|s/s))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? do not screening positive)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:be negative|not test positive))#negated
(?i)(?:(?:be negative|not test positive|not? screening(?: for)|no signs of|no (?:sign|symptom|indication(?:of|for)?)|not? test(?:\S+)? for)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:no exposure|(?:without|w/o) (?:signs|symptoms)(?:or (?:signs|symptoms))|do)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,4} not have)#negated
(?i)(?:(?:(?:not|n't) have a (?:positive )?diagnosis|do not meet criteria|no concern (?:for|of)|not? (?:at )risk)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:(?:not|n't) have a (?:positive )?diagnosis|do not meet criteria))#negated
(?i)(?:(?:no suspicion(?: for)|not suspect|ruled out for|no(?: recent) travel|not be in|clear(?:ed|s|ing) (?:of|for|from))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:not(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:be ruled out|be not likely|not have contact with))#negated
(?i)(?:(?:no (?:hx|history) (?:of )travel|not have contact with|no symptoms of|no risk factors|no (?:confirm case|report))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:no (?:exposure|contact) (?:to|with)|not test(?:\S+)? positive))#negated
(?i)(?:(?:no (?:exposure|contact) (?:to|with)|do (?:not|n't) meet(?: screening)(?: criteria)(?: for)|not test(?:\S+)? positive(?: for)|not tested(?: or diagnosis))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:no|any)(?: known) contact(?: with)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,3} : no)#negated
(?i)(?:(?:(?:not|never) diagnosis with|not been tested (?:for )?or diagnosis with)(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,1} confirm)#positive
(?i)(?:(?:confirm|known)(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#positive
(?i)(?:(?:(?:test(?:\S+)?)?positive(?: for)?|notif(?:y|ied) of positive (?:results?|test(?:\S+)?|status))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:positiv(?:e|ity)|test(?:\S+)? positive|(?:test|pcr) remains positive|notif(?:y|ied) of positive (?:results?|test(?:ing)?|status)))#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:positiv(?:e|ity)|test(?:\S+)? positive|(?:test|pcr) remains positive|notif(?:y|ied) of positive (?:results?|test(?:ing)?|status)))#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,2} (?:positive status|results be positive))#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,4} results positive)#positive
(?i)(?:results positive(?: (?!&lt;IGNORE&gt;)\S+){0,4} COVID-19)#positive
(?i)(?:notif(?:y|ied) (?:the )? (?:veteran|patient|family) of positive (?:results?|test(?:ing)?|status)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? notif(?:y|ied) (?:the )? (?:veteran|patient|family) of positive (?:results?|test(?:ing)?|status))#positive
(?i)(?:likely secondary to(?: (?!&lt;IGNORE&gt;)\S+){0,0} COVID-19)#positive
(?i)(?:(?:problem(?: list)? (?:of|:)|(?:active|current|acute) problems :|admi(?:t|ssion) diagnosis(?: :)?)(?: (?!&lt;IGNORE&gt;)\S+){0,9} COVID-19)#positive
(?i)(?:(?:reason for admission :|treatment of|(?:admitting )diagnosis(?: :)?)(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,3} diagnosis like_num)#positive
(?i)(?:(?:Reason for admission :|inpatient with|discharged from|in m?icu (?:for|with))(?: (?!&lt;IGNORE&gt;)\S+){0,5} COVID-19)#admission
(?i)(?:(?:admit(?:ted|s|ting) (?:like_num|with|for)|admitted (?:to|on)|Reason for ICU :|admission for)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#admission
(?i)(?:Reason for ED visit or Hospital Admission :(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#admission
(?i)(?:(?:(?:in|to) (?:the )(?:hospital|icu|micu) (?:for|due to)|hospitali(?:zed)?(?: timesx)? (?:for|due to))(?: (?!&lt;IGNORE&gt;)\S+){0,4} COVID-19)#admission
(?i)(?:(?:diagnosis with|found to be positive for)(?: (?!&lt;IGNORE&gt;)\S+){0,5} COVID-19)#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,5} found to be positive)#positive
(?i)(?:(?:positive test|presum(?:e|ed|es|ing) positive|not(?: yet)? recover(?:s|ing|ed)?)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:positive test|presum(?:e|ed|es|ing) positive))#positive
(?i)(?:(?:management of|ards(?: (?:from|with|secondary to))?|acute respiratory distress|post - extubation)(?: (?!&lt;IGNORE&gt;)\S+){0,2} COVID-19)#positive
(?i)(?:(?:in(?: the)? setting of|in the s / o|found to have|present(?:s|ed|ing)? with)(?: (?!&lt;IGNORE&gt;)\S+){0,5} COVID-19)#positive
(?i)(?:resp(?:iratory) failure(?:(?: (?:with|due to))?|like_num|\( like_num \))(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#positive
(?i)(?:(?:active(?: for)|recovering from)(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,2} recovering from)#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,4} (?:detected|value : detected|POSITIVEH))#positive
(?i)(?:(?:\d+(?: )?-|like_num )year(?:(?: )?-(?: )?old| old) (?:(?:aa|white|black|hispanic|caucasian) )?(?:\b(?!family\b|other_experiencer\b)\S+\b )?(?:with|w|w/|admitted)(?: (?!&lt;IGNORE&gt;)\S+){0,9} COVID-19)#patient_experiencer
(?i)(?:(?:like_num (?:y[or]|y / o)|[\d]+yo) (?:\b(?!family\b|other_experiencer\b)\S+\b )?(?:patient |veteran )?(?:with|w|w/)(?: (?!&lt;IGNORE&gt;)\S+){0,9} COVID-19)#patient_experiencer
(?i)(?:the (?:veteran|vet|patient) have(?: (?!&lt;IGNORE&gt;)\S+){0,2} COVID-19)#patient_experiencer
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,1} precaution)#future
(?i)(?:(?:(?:precaution|protection|protect) (?:for|against)|concern about|reports of|vaccine|protect yourself|prevent(?:ed|ion|s|ing)|avoid)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#future
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:prevent(?:ed|ion|s|ing)|vaccine|educat\S*|instruction))#future
(?i)(?:(?:questions (?:about|regarding|re|concerning|on|for)|(?:anxiety|ask(?:ing|ed|es|ed)?) about|educat(?:ion|ed|ing|ed)?|instruction)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#future
(?i)(?:(?:information(?: )?(?:on|about|regarding|re)?|protocols?)(?: (?!&lt;IGNORE&gt;)\S+){0,2} COVID-19)#future
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,2} protocols?)#future
(?i)(?:(?:materials|fact(?: )?sheet|literature|(?:informat(?:ion|ed|ing) )?handouts?|(?:anxious|worr(?:ied|ies|y|ying)) (?:about|re|regarding))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#future
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:materials|fact(?: )?sheet|literature|(?:informat(?:ion|ed|ing) )?handouts?))#future
(?i)(?:if(?: (?!&lt;IGNORE&gt;)\S+){0,9} COVID-19)#future
(?i)(?:(?:advisor(?:y|ies)|travel screen(?: :)?|Travel History Questionnaire|prescreen|front gate)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#screening
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,2} (?:questionnaire :|questionn?aire|question\S*|prescreen|front gate))#screening
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,9} screen\S*)#screening
(?i)(?:screen\S*(?: (?!&lt;IGNORE&gt;)\S+){0,9} COVID-19)#screening
(?i)(?:have you(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#not relevant
(?i)(?:(?:mers)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:This patient was screened for the following suspected travel related illness(?:es)?)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#future
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? This patient was screened for the following suspected travel related illness(?:es)?)#future
(?i)(?:(?:will(?: be) travel|travel plans|if you need|plan to travel)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#future
(?i)(?:(?:(?:limit|reduce|lower|minimize)(?: the)? (?:risk|chance|possibility) of|if you)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#future
(?i)(?:(?:(?:(?:-)?hx|history|) of)(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#negated
(?i)(?:(?:^(?:check|test|retest|eval)(?: for)?)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#test
(?i)(?:(?:work(?:-|\s)up)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#test
(?i)(?:(?:evaluation)(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#test
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,1} (?:evaluation))#test
(?i)(?:(?:swab|PCR|specimen sent)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#test
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:swab|PCR|specimen sent))#test
(?i)(?:(?:awaiting results|at risk for|risk for|currently being ruled out or has tested positive for|to exclude)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:awaiting results|currently being ruled out or has tested positive for|(?:patient|person) of interest))#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,0} (?:risk))#uncertain
(?i)(?:(?:investigation of)(?: (?!&lt;IGNORE&gt;)\S+){0,0} COVID-19)#uncertain
(?i)(?:(?:question of|differential diagnosis :|ddx :)(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#uncertain
(?i)(?:(?:awaiting|questionnaire|r(?:/)?o(?:\.)?)(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,1} (?:awaiting|questionnaire|r(?:/)?o(?:\.)?))#uncertain
(?i)(?:(?:under investigation|(?:may|might) be positive(?: for)?|flew|tarvel(?:ed)?|travelled)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:under investigation|(?:may|might) be positive))#uncertain
(?i)(?:(?:facility (?:with|has)(?: a)?|known to have|(?:same )?room|patients with)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:(?:area|county|community|city) (?:with|of)|in the building|(?:several|multiple|one)(?:of )?(?:the )? other_experiencer)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:in the building))#negated
(?i)(?:(?:(?:he|she) thinks (?:he|she) (?:have|had|has)|\S+ would like)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:positive (?:screen|criteria|triage)|(?:^test )?pending|screen positive|unlikely to be)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:positive (?:screen|criteria|triage)|(?:^test )?pending|screen positive|possible positive))#uncertain
(?i)(?:(?:(?:possible|potential)? exposure|possibly|possible positive)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#uncertain
(?i)(?:(?:risk of|likely|probable|probably)(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#uncertain
(?i)(?:(?:suspicion(?: for)?|^suspect|differential diagnosis|ddx(?: :)?|doubt)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:suspicion|^suspect|differential diagnosis|ddx(?: :)?|may have been exposed))#uncertain
(?i)(?:(?:(?:positive )?(?:sign|symptom) of)(?: (?!&lt;IGNORE&gt;)\S+){0,3} COVID-19)#uncertain
(?i)(?:(?:sx|s/s|rule (?:- )out|be ruled out(?: for)?|^(?:vs\.?|versus)$)(?: (?!&lt;IGNORE&gt;)\S+){0,4} COVID-19)#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,4} (?:sx|s/s|rule (?:- )out|^(?:vs\.?|versus)$))#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:(?:possible|potential)? exposure|may have been exposed))#uncertain
(?i)(?:(?:concern(:?s)?(?: for| of)?|if (?:negative|positive)|c/f|assess(?:ed)? for|concerning for)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#uncertain
(?i)(?:(?:unlikely(?: to be positive)?|low (?:suspicion|probability|risk (?:for|in|of)))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:unlikely(?: to be positive)?|low (?:suspicion|probability)|is unlikely))#uncertain
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,2} (?:extremely low))#uncertain
(?i)(?:(?:low risk of)(?: (?!&lt;IGNORE&gt;)\S+){0,2} COVID-19)#uncertain
(?i)(?:(?:(?:other_experiencer|family) ^test positive(?: for)?|any one|contact with(?: known))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:other_experiencer|family)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:other_experiencer|any one|contact with(?: known)))#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,0} (?:(?:a|an|another) \S+ tested positive))#negated
(?i)(?:(?:had contact|same (?:building|floor)|care for|clean)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:had contact|same (?:building|floor)|care for|clean))#negated
(?i)(?:(?:concern(?:ed)? about)(?: (?!&lt;IGNORE&gt;)\S+){0,2} COVID-19)#negated
(?i)(?:(?:patient concern (?:for|of)|desire|(?:concerned|prepare) (?:for|about))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:seen in|a (?:positive|confirmed) case of|cases|epidemic|pandemic)(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,1} (?:cases|epidemic|pandemic|national emergency|crisis|situation|mandate|\?))#negated
(?i)(?:(?:national emergency|crisis|situation|mandate)(?: (?!&lt;IGNORE&gt;)\S+){0,1} COVID-19)#negated
(?i)(?:(?:seen in(?: the)? setting of)(?: (?!&lt;IGNORE&gt;)\S+){0,5} COVID-19)#negated
(?i)(?:(?:^cancel (?:flight|plan|trip|vacation)|supposed to (?:travel|go|visit)|called off|goals :)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:^cancel (?:flight|plan|trip|vacation)|supposed to (?:travel|go|visit)|called off))#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:in the (?:area|community)|outbreak))#negated
(?i)(?:(?:in the (?:area|community)|outbreak)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:news|media|tv|television|broadcast|headline(?:s)?|newspaper(?:s)?|clinic cancellation)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:news|media|tv|television|broadcast|headline(?:s)?|newspaper(?:s)?|clinic cancellation))#negated
(?i)(?:(?:^read about|deploy|(?:come|been) in close contact(?: with)?)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:^read about|deploy|(?:come|been) in close contact(?: with)?|error))#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:have you had close contact|web(?:\s)?site|internet|world(?:\s|-)?wide|countries with cases))#negated
(?i)(?:(?:have you had close contact|the group|session|(?:nurse(?:s)?|rn) notes)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:web(?:\s)?site|internet|world(?:\s|-)?wide|countries with cases|error)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:(?:(?:person|patients) with(?: confirmed)?(?: or)?(?: suspected)?|cases of)(?: (?!&lt;IGNORE&gt;)\S+){0,2} COVID-19)#negated
(?i)(?:elective(?: (?!&lt;IGNORE&gt;)\S+){0,4} COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,4} elective)#negated
(?i)(?:(?:reschedule|barrier to travel|positive (?:individual(?:s)?|contact(?:s)?|patient(?:s)?))(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:reschedule|barrier to travel|positive (?:individual(?:s)?|contact(?:s)?|patient(?:s)?)))#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:(?:someone|person) who (?:has|have) tested positive|contact with))#negated
(?i)(?:(?:(?:someone|person) who (?:has|have) tested positive|contact with)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#negated
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+){0,0} (?:\(resolved\)))#positive
(?i)(?:COVID-19(?: (?!&lt;IGNORE&gt;)\S+)*? (?:social worker|initially negative|likely recovered|not aware|positive (?:case|symptom|sign)|client history|emergency contact|several positive|special instructions :))#IGNORE
(?i)(?:(?:social worker|initially negative|likely recovered|not aware|positive (?:case|symptom|sign)|client history|emergency contact|several positive|special instructions :)(?: (?!&lt;IGNORE&gt;)\S+)*? COVID-19)#IGNORE</code></pre>
</div>
</div>
<div id="cell-87" class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"context_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"ContextRules"</span>, delimiter<span class="op">=</span><span class="st">"#"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-88" class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co">#covid_attributes: negated, other_experiencer, is_future, not_relevant, uncertain, positive</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>ContextMatches(CovidAttribute, Span, Path, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), ContextRules(Pattern, CovidAttribute),<span class="op">\</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>py_rgx_span(Sent, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>?ContextMatches(CovidAttribute, Span, Path, Sent)</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>CovidSpans(Path, Span, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), py_rgx_span(Sent, <span class="st">"COVID-19"</span>) <span class="op">-&gt;</span> (Span)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>?CovidSpans(Path, Span, Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'ContextMatches(CovidAttribute, Span, Path, Sent)':
   CovidAttribute    |   Span   |    Path     |                        Sent
---------------------+----------+-------------+----------------------------------------------------
      positive       | [0, 17)  | sample5.txt |           positive COVID-19 precaution .
       negated       | [0, 12)  | sample4.txt |              neg COVID-19 education .
      positive       | [27, 48) | sample1.txt | His family recently tested positive for COVID-19 .
      positive       | [0, 35)  | sample1.txt |       COVID-19 results came back positive .
 patient_experiencer | [0, 34)  | sample6.txt |        The patient have reported COVID-19 .
       future        | [9, 28)  | sample5.txt |           positive COVID-19 precaution .
       future        | [4, 22)  | sample4.txt |              neg COVID-19 education .
       negated       | [4, 48)  | sample1.txt | His family recently tested positive for COVID-19 .

printing results for query 'CovidSpans(Path, Span, Sent)':
    Path     |   Span   |                        Sent
-------------+----------+----------------------------------------------------
 sample1.txt |  [0, 8)  |       COVID-19 results came back positive .
 sample1.txt | [40, 48) | His family recently tested positive for COVID-19 .
 sample1.txt | [34, 42) |    patient presents to be tested for COVID-19 .
 sample2.txt | [26, 34) |        The patient be tested for COVID-19 .
 sample3.txt |  [0, 8)  |                 COVID-19 like_num
 sample4.txt | [4, 12)  |              neg COVID-19 education .
 sample5.txt | [9, 17)  |           positive COVID-19 precaution .
 sample6.txt | [26, 34) |        The patient have reported COVID-19 .
</code></pre>
</div>
</div>
<div id="cell-89" class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, CovidAttribute, Sent) <span class="op">&lt;-</span> ContextMatches(CovidAttribute, Span1, Path, Sent), CovidSpans(Path, Span2, Sent), is_span_contained(Span1, Span2) <span class="op">-&gt;</span> (CovidSpan)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>?CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)':
    Path     |  CovidSpan  |   CovidAttribute    |                        Sent
-------------+-------------+---------------------+----------------------------------------------------
 sample1.txt |   [0, 8)    |      positive       |       COVID-19 results came back positive .
 sample1.txt |  [40, 48)   |       negated       | His family recently tested positive for COVID-19 .
 sample1.txt |  [40, 48)   |      positive       | His family recently tested positive for COVID-19 .
 sample3.txt |   [0, 8)    |      positive       |                 COVID-19 like_num
 sample4.txt |   [4, 12)   |       future        |              neg COVID-19 education .
 sample4.txt |   [4, 12)   |       negated       |              neg COVID-19 education .
 sample5.txt |   [9, 17)   |       future        |           positive COVID-19 precaution .
 sample5.txt |   [9, 17)   |      positive       |           positive COVID-19 precaution .
 sample6.txt |  [26, 34)   | patient_experiencer |        The patient have reported COVID-19 .
</code></pre>
</div>
</div>
</section>
<section id="postprocessor" class="level3">
<h3 class="anchored" data-anchor-id="postprocessor"><a href="https://github.com/abchapman93/VA_COVID-19_NLP_BSV/blob/master/cov_bsv/knowledge_base/postprocess_rules.py">Postprocessor</a>:</h3>
<p>The postprocessor is designed to apply extra adjustments to the processed text using custom logic or specific requirements not addressed by the spaCy pipeline. These rules modify, remove, or change attributes for each mention of COVID-19 based on either their existing attributes, the context of the sentences in which they appear, or a combination of both. This flexibility allows us to address data issues and implement targeted improvements. For instance, it proves useful in identifying and rectifying incorrectly labeled positive cases, thereby enhancing the accuracy of our classification.</p>
<p><strong>How we implemented it:</strong><br>
As mentioned earlier, postprocess rules are responsible for modifying, removing, or changing attributes for each mention of COVID-19. In the original project, these attributes are represented as boolean variables stored in an object class for each COVID-19 mention. The rules simply switch the corresponding boolean variable to assign or remove the attribute. However, in spannerlog, we don’t have the luxury of creating classes. In our project, when we want to remove a specific attribute, we introduce an additional attribute that acts as its negation. For instance, for the attribute ‘positive,’ we add ‘no_positive,’ causing the document classifier to behave as if there is no positive attribute.</p>
<p>Additionally, in some cases, the entire COVID-19 mention is removed by eliminating its object. In our project, we introduce an ‘IGNORE’ attribute, which results in the exclusion of the mention from consideration in the document classifier stage. <br></p>
<p><strong>In the subsequent cells, we will explore three types of postprocess rules:</strong> 1) Rules based on patterns 2) Rules utilizing existing attributes and patterns 3) Rules applied to the next sentence.</p>
<section id="postprocess-rules-based-on-patterns" class="level4">
<h4 class="anchored" data-anchor-id="postprocess-rules-based-on-patterns">1 - Postprocess rules based on patterns:</h4>
<p>Example rule in the original project:</p>
<pre><code>PostprocessingRule(
        patterns=[
            PostprocessingPattern(lambda ent: ent.label_ == "COVID-19"),
            PostprocessingPattern(
                postprocessing_functions.sentence_contains,
                condition_args=({"deny", "denies", "denied"},),
            ),
            PostprocessingPattern(
                postprocessing_functions.sentence_contains,
                condition_args=({"contact", "contacts", "confirmed"},),
            ),
        \],
        action=postprocessing_functions.remove_ent,
        description="Remove a coronavirus entity if 'denies' and 'contact' are in. This will help get rid of false positives from screening.",
    ),    </code></pre>
<p>This rule iterates through each entity and checks a series of conditions which are the “PostprocessingPattern”. If all conditions evaluate as True, then some action is taken on the entity, which is ‘remove’ action in this example.</p>
<p>In our case, we assign “IGNORE” attribute to the COVID-19 mention causing it to be excluded from consideration during the document classification process.</p>
<p>Each rule in the CSV file follows this format: regexPattern, Attribute</p>
<div id="cell-92" class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'postprocess_pattern_rules.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.*education.*#IGNORE
.* \?#IGNORE
(?=.*\b(?:deny|denies|denied)\b)(?=.*\b(?:contact|confirm)\b).*#IGNORE
(?=.*\b(?:setting of|s/o)\b)(?!.*\b(?:COVID-19 infection|COVID-19 ards)\b).*#no_positive
(?i)(.*benign.*)#uncertain
admitted to COVID-19 unit#positive</code></pre>
</div>
</div>
<div id="cell-93" class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"postprocess_pattern_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"PostprocessRules"</span>, delimiter<span class="op">=</span><span class="st">"#"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-94" class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>PostprocessMatches(CovidAttribute, Span, Path, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), PostprocessRules(Pattern, CovidAttribute),<span class="op">\</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>py_rgx_span(Sent, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>?PostprocessMatches(CovidAttribute, Span, Path, Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'PostprocessMatches(CovidAttribute, Span, Path, Sent)':
  CovidAttribute  |  Span   |    Path     |           Sent
------------------+---------+-------------+--------------------------
      IGNORE      | [0, 24) | sample4.txt | neg COVID-19 education .
</code></pre>
</div>
</div>
<div id="cell-95" class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, CovidAttribute, Sent) <span class="op">&lt;-</span> PostprocessMatches(CovidAttribute, Span1, Path, Sent), CovidSpans(Path, Span2, Sent), is_span_contained(Span1, Span2) <span class="op">-&gt;</span> (CovidSpan)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>?CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)':
    Path     |  CovidSpan  |   CovidAttribute    |                        Sent
-------------+-------------+---------------------+----------------------------------------------------
 sample1.txt |   [0, 8)    |      positive       |       COVID-19 results came back positive .
 sample1.txt |  [40, 48)   |       negated       | His family recently tested positive for COVID-19 .
 sample1.txt |  [40, 48)   |      positive       | His family recently tested positive for COVID-19 .
 sample3.txt |   [0, 8)    |      positive       |                 COVID-19 like_num
 sample4.txt |   [4, 12)   |       IGNORE        |              neg COVID-19 education .
 sample4.txt |   [4, 12)   |       future        |              neg COVID-19 education .
 sample4.txt |   [4, 12)   |       negated       |              neg COVID-19 education .
 sample5.txt |   [9, 17)   |       future        |           positive COVID-19 precaution .
 sample5.txt |   [9, 17)   |      positive       |           positive COVID-19 precaution .
 sample6.txt |  [26, 34)   | patient_experiencer |        The patient have reported COVID-19 .
</code></pre>
</div>
</div>
</section>
<section id="postprocess-rules-utilizing-existing-attributes-and-patterns" class="level4">
<h4 class="anchored" data-anchor-id="postprocess-rules-utilizing-existing-attributes-and-patterns">2 - Postprocess rules utilizing existing attributes and patterns:</h4>
<pre><code>PostprocessingRule(
        patterns=[
        
            PostprocessingPattern(lambda ent: ent.label_ == "COVID-19"),
            PostprocessingPattern(
                postprocessing_functions.is_modified_by_category,
                condition_args=("DEFINITE_POSITIVE_EXISTENCE",),
            ),
            # PostprocessingPattern(postprocessing_functions.is_modified_by_category, condition_args=("TEST",)),
            PostprocessingPattern(
                postprocessing_functions.sentence_contains,
                condition_args=(
                    {
                        "should",
                        "unless",
                        "either",
                        "if comes back",
                        "if returns",
                        "if s?he tests positive",
                    },
                    True,
                ),
            ),
        ],
        action=set_is_uncertain,
        action_args=(True,),
        description="Subjunctive of test returning positive. 'Will contact patient should his covid-19 test return positive.'",
    ),</code></pre>
<p>This rule examines whether a COVID-19 mention possesses a positive attribute and if the sentence containing it includes any of the words specified in ‘condition_args’ If these conditions are met, the uncertain attribute is set to true.</p>
<p>In our case, we check for each COVID-19 mention in the ‘CovidAttributes’ table if it’s labeled as ‘positive’, also, we check if any of the specified words in ‘condition_args’ are present in the same sentence using a regex search. If the conditions are met, then we simply assign it an ‘uncertain’ attribute.</p>
<p>Each rule in the CSV file follows this format: regexPattern, ExistingAttribute, NewAttribute</p>
<div id="cell-97" class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>print_csv_file(<span class="st">'postprocess_attributes_rules.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.*pending.*#negated#no_negated
.*(?:should|unless|either|if comes back|if returns|if s?he tests positive).*#positive#uncertain
.*precaution.*#positive#no_future
.*(?:re[ -]?test|second test|repeat).*#negated#no_negated
.*(?:sign|symptom|s/s).*#positive#uncertain</code></pre>
</div>
</div>
<div id="cell-98" class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"postprocess_attributes_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"PostprocessRulesWithAttributes"</span>, delimiter<span class="op">=</span><span class="st">"#"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-99" class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>PostprocessWithAttributesMatches(CovidAttribute, NewAttribute, Span, Path, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), PostprocessRulesWithAttributes(Pattern, CovidAttribute, NewAttribute),<span class="op">\</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>py_rgx_span(Sent, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>?PostprocessWithAttributesMatches(CovidAttribute, NewAttribute, Span, Path, Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'PostprocessWithAttributesMatches(CovidAttribute, NewAttribute, Span, Path, Sent)':
  CovidAttribute  |  NewAttribute  |  Span   |    Path     |              Sent
------------------+----------------+---------+-------------+--------------------------------
     positive     |   no_future    | [0, 30) | sample5.txt | positive COVID-19 precaution .
</code></pre>
</div>
</div>
<div id="cell-100" class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, NewAttribute, Sent) <span class="op">&lt;-</span> CovidAttributes(Path, CovidSpan, CovidAttribute, Sent), PostprocessWithAttributesMatches(CovidAttribute, NewAttribute, Span, Path, Sent)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>?CovidAttributes(Path, CovidSpan, NewAttribute, Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'CovidAttributes(Path, CovidSpan, NewAttribute, Sent)':
    Path     |  CovidSpan  |    NewAttribute     |                        Sent
-------------+-------------+---------------------+----------------------------------------------------
 sample1.txt |   [0, 8)    |      positive       |       COVID-19 results came back positive .
 sample1.txt |  [40, 48)   |       negated       | His family recently tested positive for COVID-19 .
 sample1.txt |  [40, 48)   |      positive       | His family recently tested positive for COVID-19 .
 sample3.txt |   [0, 8)    |      positive       |                 COVID-19 like_num
 sample4.txt |   [4, 12)   |       IGNORE        |              neg COVID-19 education .
 sample4.txt |   [4, 12)   |       future        |              neg COVID-19 education .
 sample4.txt |   [4, 12)   |       negated       |              neg COVID-19 education .
 sample5.txt |   [9, 17)   |       future        |           positive COVID-19 precaution .
 sample5.txt |   [9, 17)   |      no_future      |           positive COVID-19 precaution .
 sample5.txt |   [9, 17)   |      positive       |           positive COVID-19 precaution .
 sample6.txt |  [26, 34)   | patient_experiencer |        The patient have reported COVID-19 .
</code></pre>
</div>
</div>
</section>
<section id="postprocess-rules-applied-to-the-next-sentence" class="level4">
<h4 class="anchored" data-anchor-id="postprocess-rules-applied-to-the-next-sentence">3 - Postprocess rules applied to the next sentence:</h4>
<p>There’s a rule that checks if the following sentence contains positive mentions. If it does, the COVID-19 mentions in the current sentence are also marked as positive. To Implement this rule in our project, we defined a new relation that pairs each sentence with its subsequent sentence.</p>
<div id="cell-102" class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> next_sent(text_path):</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(text_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>        contents <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(contents)</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tokenize sentences</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    sentences <span class="op">=</span> <span class="bu">list</span>(doc.sents)</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(sentences) <span class="op">-</span> <span class="dv">1</span>):  <span class="co"># Iterate until the second-to-last sentence</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span>(sentences[i].text, sentences[i <span class="op">+</span> <span class="dv">1</span>].text)</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>magic_session.register(ie_function<span class="op">=</span>next_sent, ie_function_name <span class="op">=</span> <span class="st">"next_sent"</span>, in_rel<span class="op">=</span>[DataTypes.string], out_rel<span class="op">=</span>[DataTypes.string,DataTypes.string])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-103" class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> first_sent, second_sent <span class="kw">in</span> next_sent(<span class="st">"sample1.txt"</span>):</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"sentence: </span><span class="sc">{</span>first_sent<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"next sentence: </span><span class="sc">{</span>second_sent<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>sentence: patient presents to be tested for COVID-19 . next sentence: His family recently tested positive for COVID-19 .
sentence: His family recently tested positive for COVID-19 . next sentence: COVID-19 results came back positive .</code></pre>
</div>
</div>
<div id="cell-104" class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>NextSent(Path, Sent1, Sent2) <span class="op">&lt;-</span> FilesPaths(Path), next_sent(Path) <span class="op">-&gt;</span> (Sent1, Sent2)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>?NextSent(Path, Sent1, Sent2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'NextSent(Path, Sent1, Sent2)':
    Path     |                       Sent1                        |                       Sent2
-------------+----------------------------------------------------+----------------------------------------------------
 sample1.txt | His family recently tested positive for COVID-19 . |       COVID-19 results came back positive .
 sample1.txt |    patient presents to be tested for COVID-19 .    | His family recently tested positive for COVID-19 .
 sample2.txt |        The patient be tested for COVID-19 .        |               Results be positive .
 sample3.txt |                associated_diagnosis                |                     like_num .
 sample3.txt |                     like_num .                     |                 COVID-19 like_num
 sample3.txt |             problem_list : like_num .              |                associated_diagnosis
</code></pre>
</div>
</div>
<div id="cell-105" class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>new PostProcessWithNextSentenceRules(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>PostProcessWithNextSentenceRules(<span class="st">"(?i)(?:^(?:positive|detected)|results?(?: be)? positive)"</span>, <span class="st">"positive"</span>)</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>PostProcessWithNextSentenceMatches(CovidAttribute, Span, Path, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), PostProcessWithNextSentenceRules(Pattern, CovidAttribute),<span class="op">\</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>py_rgx_span(Sent, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, CovidAttribute, Sent1) <span class="op">&lt;-</span> CovidSpans(Path, CovidSpan, Sent1), NextSent(Path, Sent1, Sent2), PostProcessWithNextSentenceMatches(CovidAttribute, Span, Path, Sent2)</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>?CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)':
    Path     |  CovidSpan  |   CovidAttribute    |                        Sent
-------------+-------------+---------------------+----------------------------------------------------
 sample1.txt |   [0, 8)    |      positive       |       COVID-19 results came back positive .
 sample1.txt |  [40, 48)   |       negated       | His family recently tested positive for COVID-19 .
 sample1.txt |  [40, 48)   |      positive       | His family recently tested positive for COVID-19 .
 sample2.txt |  [26, 34)   |      positive       |        The patient be tested for COVID-19 .
 sample3.txt |   [0, 8)    |      positive       |                 COVID-19 like_num
 sample4.txt |   [4, 12)   |       IGNORE        |              neg COVID-19 education .
 sample4.txt |   [4, 12)   |       future        |              neg COVID-19 education .
 sample4.txt |   [4, 12)   |       negated       |              neg COVID-19 education .
 sample5.txt |   [9, 17)   |       future        |           positive COVID-19 precaution .
 sample5.txt |   [9, 17)   |      no_future      |           positive COVID-19 precaution .
 sample5.txt |   [9, 17)   |      positive       |           positive COVID-19 precaution .
 sample6.txt |  [26, 34)   | patient_experiencer |        The patient have reported COVID-19 .
</code></pre>
</div>
</div>
</section>
</section>
<section id="document-classifier" class="level3">
<h3 class="anchored" data-anchor-id="document-classifier"><a href="https://github.com/abchapman93/VA_COVID-19_NLP_BSV/blob/master/cov_bsv/knowledge_base/document_classifier.py">Document Classifier</a>:</h3>
<p>Now we have the basic pieces in place to make our document classification. Each document is classified as either ‘POS’, ‘UNK’, or ‘NEG’ determined by the attributes of its COVID-19 mentions. The Results are stored in a DataFrame.</p>
<p>Document Classifier stage has 2 parts: 1) <strong>Attribute filtering</strong>: Our pipeline assigns various attributes to each COVID-19 mention. However, during this stage, each COVID-19 case is refined to possess only one attribute. This filtering process operates based on specific conditions outlined in the ‘attribute_filter’ function. 2) <strong>Document classification</strong>: Documents are classified based on distinct conditions, as detailed in the ‘classify_doc_helper’ function. This step ensures the accurate categorization of each document according to the specified criteria.</p>
<div id="cell-107" class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> attribute_filter(group):</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Filters attributes within each "CovidSpan" of a DataFrame table based on specific conditions.</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="co">        group (pandas.Series): A pandas Series representing attributes for each "CovidSpan" within a DataFrame.</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Filtered "CovidSpan" attribute determined by the following rules:</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a><span class="co">            - If 'IGNORE' is present, returns 'IGNORE'.</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a><span class="co">            - If 'negated' is present (and 'no_negated' is not present), returns 'negated'.</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a><span class="co">            - If 'future' is present (and 'no_future' is not present), returns 'negated'.</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a><span class="co">            - If 'other experiencer' or 'not relevant' is present, returns 'negated'.</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a><span class="co">            - If 'positive' is present (and 'uncertain' and 'no_positive' are not present), returns 'positive'.</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a><span class="co">            - Otherwise, returns 'uncertain'.</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'IGNORE'</span> <span class="kw">in</span> group.values:</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'IGNORE'</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'negated'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_negated'</span> <span class="kw">in</span> group.values:</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'future'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_future'</span> <span class="kw">in</span> group.values:</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'other experiencer'</span> <span class="kw">in</span> group.values <span class="kw">or</span> <span class="st">'not relevant'</span> <span class="kw">in</span> group.values:</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'positive'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'uncertain'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_positive'</span> <span class="kw">in</span> group.values:</span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'positive'</span></span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'uncertain'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-108" class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {<span class="st">'Path'</span>: [<span class="st">"sample1.txt"</span>, <span class="st">"sample1.txt"</span>, <span class="st">"sample1.txt"</span>, <span class="st">"sample2.txt"</span>],</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Attribute'</span>: [<span class="st">'IGNORE'</span>, <span class="st">'negated'</span>, <span class="st">'positive'</span>, <span class="st">'positive'</span>]}</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>df_example <span class="op">=</span> pd.DataFrame(data)</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Before:"</span>)</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_example)</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>df_example[<span class="st">'Attribute'</span>] <span class="op">=</span> df_example.groupby([<span class="st">'Path'</span>])[<span class="st">'Attribute'</span>].transform(attribute_filter)</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>df_example <span class="op">=</span> df_example.drop_duplicates().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">After:"</span>)</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Before:
          Path Attribute
0  sample1.txt    IGNORE
1  sample1.txt   negated
2  sample1.txt  positive
3  sample2.txt  positive

After:
          Path Attribute
0  sample1.txt    IGNORE
1  sample2.txt  positive</code></pre>
</div>
</div>
<div id="cell-109" class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (magic_session.run_commands(<span class="st">"?CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)"</span>, print_results<span class="op">=</span><span class="va">False</span>, format_results<span class="op">=</span><span class="va">True</span>))[<span class="dv">0</span>]</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> DataFrame(columns<span class="op">=</span>[<span class="st">"Path"</span>,<span class="st">"CovidSpan"</span>,<span class="st">"CovidAttribute"</span>])</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'CovidAttribute'</span>] <span class="op">=</span> df.groupby([<span class="st">'CovidSpan'</span>, <span class="st">'Sent'</span>])[<span class="st">'CovidAttribute'</span>].transform(attribute_filter)</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.drop_duplicates().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Path</th>
<th data-quarto-table-cell-role="th">CovidSpan</th>
<th data-quarto-table-cell-role="th">CovidAttribute</th>
<th data-quarto-table-cell-role="th">Sent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>sample1.txt</td>
<td>[0, 8)</td>
<td>positive</td>
<td>COVID-19 results came back positive .</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>sample1.txt</td>
<td>[40, 48)</td>
<td>negated</td>
<td>His family recently tested positive for COVID-...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>sample2.txt</td>
<td>[26, 34)</td>
<td>positive</td>
<td>The patient be tested for COVID-19 .</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>sample3.txt</td>
<td>[0, 8)</td>
<td>positive</td>
<td>COVID-19 like_num</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>sample4.txt</td>
<td>[4, 12)</td>
<td>IGNORE</td>
<td>neg COVID-19 education .</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>sample5.txt</td>
<td>[9, 17)</td>
<td>positive</td>
<td>positive COVID-19 precaution .</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>sample6.txt</td>
<td>[26, 34)</td>
<td>uncertain</td>
<td>The patient have reported COVID-19 .</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-110" class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_doc_helper(group):</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="co">Classifies a document as 'POS', 'UNK', or 'NEG' based on COVID-19 attributes.</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="co">Parameters:</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="co">    group (pandas.Series): A pandas Series representing COVID-19 attributes for each document within a DataFrame.</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a><span class="co">Returns:</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a><span class="co">    str: Document classification determined as follows:</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="co">         - 'POS': If at least one COVID-19 attribute with "positive" is present in the group.</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="co">         - 'UNK': If at least one COVID-19 attribute with "uncertain" is present in the group and no "positive" attributes,</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a><span class="co">                  or there's at least one COVID-19 attribute with 'IGNORE' and no other COVID-19 attributes exist.</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a><span class="co">         - 'NEG': Otherwise.</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'positive'</span> <span class="kw">in</span> group.values:</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'POS'</span></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'uncertain'</span> <span class="kw">in</span> group.values:</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'UNK'</span></span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'negated'</span> <span class="kw">in</span> group.values:</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'NEG'</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'UNK'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-111" class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># usage example</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {<span class="st">'Path'</span>: [<span class="st">"sample1.txt"</span>, <span class="st">"sample1.txt"</span>, <span class="st">"sample1.txt"</span>, <span class="st">"sample2.txt"</span>],</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Attribute'</span>: [<span class="st">'uncertain'</span>, <span class="st">'negated'</span>, <span class="st">'positive'</span>, <span class="st">'positive'</span>]}</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>df_example <span class="op">=</span> pd.DataFrame(data)</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Before:"</span>)</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_example)</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>df_example[<span class="st">'DocResult'</span>] <span class="op">=</span> df_example.groupby([<span class="st">'Path'</span>])[<span class="st">'Attribute'</span>].transform(classify_doc_helper)</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>df_example <span class="op">=</span> df_example[[<span class="st">'Path'</span>, <span class="st">'DocResult'</span>]]</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>df_example <span class="op">=</span> df_example.drop_duplicates().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">After:"</span>)</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Before:
          Path  Attribute
0  sample1.txt  uncertain
1  sample1.txt    negated
2  sample1.txt   positive
3  sample2.txt   positive

After:
          Path DocResult
0  sample1.txt       POS
1  sample2.txt       POS</code></pre>
</div>
</div>
<div id="cell-112" class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'DocResult'</span>] <span class="op">=</span> df.groupby(<span class="st">'Path'</span>)[<span class="st">'CovidAttribute'</span>].transform(classify_doc_helper)</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">'Path'</span>, <span class="st">'DocResult'</span>]]</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.drop_duplicates().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Path</th>
<th data-quarto-table-cell-role="th">DocResult</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>sample1.txt</td>
<td>POS</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>sample2.txt</td>
<td>POS</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>sample3.txt</td>
<td>POS</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>sample4.txt</td>
<td>UNK</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>sample5.txt</td>
<td>POS</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>sample6.txt</td>
<td>UNK</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<section id="handling-unmentioned-paths" class="level4">
<h4 class="anchored" data-anchor-id="handling-unmentioned-paths">Handling unmentioned paths:</h4>
<p>At this step, we assign a classification result ‘UNK’ to paths not identified in the previous DataFrame result. This occurs when our pipeline doesn’t detect any mention of COVID-19 or its synonyms in the text of those paths. As a result, these paths are excluded from all types of relations, consistent with our primary focus on COVID-19 entities.</p>
<div id="cell-114" class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>df_path <span class="op">=</span> (magic_session.run_commands(<span class="st">"?FilesPaths(Path)"</span>, print_results<span class="op">=</span><span class="va">False</span>, format_results<span class="op">=</span><span class="va">True</span>))[<span class="dv">0</span>]</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (pd.merge(df, df_path, on<span class="op">=</span><span class="st">'Path'</span>, how<span class="op">=</span><span class="st">'outer'</span>))</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'DocResult'</span>] <span class="op">=</span> df[<span class="st">'DocResult'</span>].fillna(<span class="st">"UNK"</span>)</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Path</th>
<th data-quarto-table-cell-role="th">DocResult</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>sample1.txt</td>
<td>POS</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>sample2.txt</td>
<td>POS</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>sample3.txt</td>
<td>POS</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>sample4.txt</td>
<td>UNK</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>sample5.txt</td>
<td>POS</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>sample6.txt</td>
<td>UNK</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>sample7.txt</td>
<td>UNK</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="bringing-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="bringing-it-all-together">Bringing It All Together</h2>
<p>In this section, we will directly compare the original Python Spacy pipeline project with its spannerlog counterpart. Our emphasis is on showcasing the overall brevity of the spannerlog implementation in contrast to the Python Spacy pipeline.</p>
<section id="code-metrics" class="level3">
<h3 class="anchored" data-anchor-id="code-metrics">Code Metrics</h3>
<p>Let’s commence by providing an estimated count of total lines in each implementation:</p>
<ul>
<li><strong>Total Number of Lines in the original Python implementation:</strong> <strong>4435</strong></li>
<li><strong>Total Number of Lines in our spannerlog implementation:</strong> <strong>596</strong> (7 times smaller!)</li>
</ul>
<p>And here’s a detailed comparison:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/line_counting.png" class="img-fluid figure-img"></p>
<figcaption>code line comparison</figcaption>
</figure>
</div>
<p>With the caveat that number of lines do not fully capture code complexity, let us analyze the lines of code a little more in depth. Analyzing our implementation vs the original we note that:</p>
<ul>
<li>We used the same libraries as the original implementations, so both
<ul>
<li>the core computations, that should turn into ie functions</li>
<li>the wrapping logic which remains in pure python did not significantly change in size.</li>
</ul></li>
<li>even if we assume that our 203 lines of python code are worth over 300 lines of the original implementations core and wrapping logic, we are still left with over 4000 lines of code that were converted into 393 (107+251+35) of either declarative code and data.</li>
<li>This means that over 90% of the original code base, which constitutes control flow and data ingestion logic, underwent a ten-fold decrease in size while providing less surface areas for errors since declarative languages and data can be statically analyzed to a greater extent than imperative code.</li>
</ul>
</section>
<section id="implementation---raw-lines-of-code" class="level3">
<h3 class="anchored" data-anchor-id="implementation---raw-lines-of-code">Implementation - raw lines of code</h3>
<p>Now, we will present the combined spannerlog and python code (excluding “generic ie” functions and excluding queries) to visually illustrate the compactness of the implementation:</p>
<section id="concept-tagger-1" class="level4">
<h4 class="anchored" data-anchor-id="concept-tagger-1">Concept tagger:</h4>
<div class="sourceCode" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lemmatize_text(text_path, lemma_words_path):</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a list of words to be lemmatized</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    lemma_words <span class="op">=</span> [line.strip() <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>lemma_words_path<span class="sc">}</span><span class="ss">"</span>) <span class="cf">if</span> line.strip()]</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(text_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>        contents <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>    nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(contents)</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>    lemmatized_text <span class="op">=</span> <span class="st">""</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> token <span class="kw">in</span> doc:</span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> token.lemma_ <span class="kw">in</span> lemma_words:</span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>            lemmatized_text <span class="op">+=</span> token.lemma_</span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> token.like_num:</span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a>            lemmatized_text <span class="op">+=</span> <span class="st">"like_num"</span></span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a>            lemmatized_text <span class="op">+=</span> token.text</span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>        lemmatized_text <span class="op">+=</span> <span class="st">" "</span></span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the lemmatized text back to the same file</span></span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(text_path, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span>.writelines(lemmatized_text)</span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> lemmatized_text</span>
<span id="cb133-26"><a href="#cb133-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-27"><a href="#cb133-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annotate_text_with_pos(text_path):</span>
<span id="cb133-28"><a href="#cb133-28" aria-hidden="true" tabindex="-1"></a>    nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb133-29"><a href="#cb133-29" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(contents)</span>
<span id="cb133-30"><a href="#cb133-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-31"><a href="#cb133-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> token <span class="kw">in</span> doc:</span>
<span id="cb133-32"><a href="#cb133-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> token.pos_ <span class="kw">in</span> [<span class="st">"NOUN"</span>, <span class="st">"PROPN"</span>, <span class="st">"PRON"</span>, <span class="st">"ADJ"</span>]:</span>
<span id="cb133-33"><a href="#cb133-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> token.pos_, Span(token.idx, token.idx <span class="op">+</span> <span class="bu">len</span>(token.text))</span>
<span id="cb133-34"><a href="#cb133-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb133-35"><a href="#cb133-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> <span class="bu">tuple</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>session.import_rel(<span class="st">"concept_tags_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"ConceptTagRules"</span>, delimiter<span class="op">=</span><span class="st">","</span>)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>LemmaMatches(Label, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), ConceptTagRules(Pattern, Label, <span class="st">"lemma"</span>), py_rgx_span(Content, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">"LemmaMatches"</span>, <span class="st">"FilesPaths"</span>)</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>POSTable(POS, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), annotate_text_with_pos(Path) <span class="op">-&gt;</span> (POS, Span)</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>POSMatches(Label, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), ConceptTagRules(Pattern, Label, <span class="st">"pos"</span>), py_rgx_span(Content, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>POSRuleMatches(Label, Span, Path) <span class="op">&lt;-</span> POSTable(POS, Span, Path), POSMatches(Label, Span, Path)</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">"POSRuleMatches"</span>, <span class="st">"FilesPaths"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="target-matcher" class="level4">
<h4 class="anchored" data-anchor-id="target-matcher">Target matcher:</h4>
<div class="sourceCode" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"target_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"TargetTagRules"</span>, delimiter<span class="op">=</span><span class="st">","</span>)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>TargetTagMatches(Label, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), TargetTagRules(Pattern, Label), py_rgx_span(Content,Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">"TargetTagMatches"</span>, <span class="st">"FilesPaths"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sectionizer" class="level4">
<h4 class="anchored" data-anchor-id="sectionizer">Sectionizer:</h4>
<div class="sourceCode" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"section_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"SectionRules"</span>, delimiter<span class="op">=</span><span class="st">","</span>)</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>SectionRulesMatches(Label, Span, Path) <span class="op">&lt;-</span> FilesContent(Path, Content), SectionRules(Pattern, Label), py_rgx_span(Content,Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>replace_spans(<span class="st">"SectionRulesMatches"</span>, <span class="st">"FilesPaths"</span>)</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>pattern <span class="op">=</span> <span class="st">"(?i)(?:diagnoses :|observation_and_plan :|past_medical_history :|problem_list :)(?:(?!labs :|addendum :|allergies :|chief_complaint :|comments :|family_history :|hospital_course :|imaging :|labs_and_studies :|medications :|neurological :|other :|patient_education :|physical_exam :|reason_for_examination :|signature :|social_history :).)*"</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>new SectionRulesAttribute(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>SectionRulesAttribute(pattern, <span class="st">"positive"</span>)</span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>SectionMatches(Path, Span, CovidAttribute) <span class="op">&lt;-</span> FilesContent(Path, Content), SectionRulesAttribute(Pattern, CovidAttribute), py_rgx_span(Content, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>CovidMatches(Path, Span) <span class="op">&lt;-</span> FilesContent(Path, Content), py_rgx_span(Content, <span class="st">"COVID-19"</span>) <span class="op">-&gt;</span> (Span)</span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>SectionCovidAttributes(Path, CovidSpan, CovidAttribute) <span class="op">&lt;-</span> SectionMatches(Path, Span1, CovidAttribute), CovidMatches(Path, Span2), is_span_contained(Span1, Span2) <span class="op">-&gt;</span> (CovidSpan)</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>Sents(Path, Sent) <span class="op">&lt;-</span> FilesPaths(Path), sent_tokenization(Path) <span class="op">-&gt;</span> (Sent)</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>SentSpans(Path, Sent, SentSpan) <span class="op">&lt;-</span> FilesContent(Path, Content), Sents(Path, Sent), py_rgx_span(Content, Sent) <span class="op">-&gt;</span> (SentSpan)</span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, CovidAttribute, Sent) <span class="op">&lt;-</span> SectionCovidAttributes(Path, AbsCovidSpan, CovidAttribute),<span class="op">\</span></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>SentSpans(Path, Sent, SentSpan) ,get_relative_span(AbsCovidSpan, SentSpan) <span class="op">-&gt;</span> (CovidSpan)</span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="context-matcher" class="level4">
<h4 class="anchored" data-anchor-id="context-matcher">Context matcher:</h4>
<div class="sourceCode" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_rel(<span class="st">"context_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"ContextRules"</span>, delimiter<span class="op">=</span><span class="st">"#"</span>)</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>ContextMatches(CovidAttribute, Span, Path, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), ContextRules(Pattern, CovidAttribute),<span class="op">\</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>py_rgx_span(Sent, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>CovidSpans(Path, Span, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), py_rgx_span(Sent, <span class="st">"COVID-19"</span>) <span class="op">-&gt;</span> (Span)</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, CovidAttribute, Sent) <span class="op">&lt;-</span> ContextMatches(CovidAttribute, Span1, Path, Sent), CovidSpans(Path, Span2, Sent), is_span_contained(Span1, Span2) <span class="op">-&gt;</span> (CovidSpan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="postprocessor-1" class="level4">
<h4 class="anchored" data-anchor-id="postprocessor-1">Postprocessor:</h4>
<div class="sourceCode" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> next_sent(text_path):</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(text_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>        contents <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(contents)</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tokenize sentences</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>    sentences <span class="op">=</span> <span class="bu">list</span>(doc.sents)</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(sentences) <span class="op">-</span> <span class="dv">1</span>):  <span class="co"># Iterate until the second-to-last sentence</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span>(sentences[i].text, sentences[i <span class="op">+</span> <span class="dv">1</span>].text)</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>magic_session.register(ie_function<span class="op">=</span>next_sent, ie_function_name <span class="op">=</span> <span class="st">"next_sent"</span>, in_rel<span class="op">=</span>[DataTypes.string], out_rel<span class="op">=</span>[DataTypes.string,DataTypes.string])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>magic_session.import_relation_from_csv(<span class="st">"postprocess_pattern_rules.csv"</span>, relation_name<span class="op">=</span><span class="st">"PostprocessRules"</span>, delimiter<span class="op">=</span><span class="st">"#"</span>)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>PostprocessMatches(CovidAttribute, Span, Path, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), PostprocessRules(Pattern, CovidAttribute),<span class="op">\</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>py_rgx_span(Sent, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, CovidAttribute, Sent) <span class="op">&lt;-</span> PostprocessMatches(CovidAttribute, Span1, Path, Sent), CovidSpans(Path, Span2, Sent), is_span_contained(Span1, Span2) <span class="op">-&gt;</span> (CovidSpan)</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>NextSent(Path, Sent1, Sent2) <span class="op">&lt;-</span> FilesPaths(Path), next_sent(Path) <span class="op">-&gt;</span> (Sent1, Sent2)</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>new PostProcessWithNextSentenceRules(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>PostProcessWithNextSentenceRules(<span class="st">"(?i)(?:^(?:positive|detected)|results?(?: be)? positive)"</span>, <span class="st">"positive"</span>)</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>PostProcessWithNextSentenceMatches(CovidAttribute, Span, Path, Sent) <span class="op">&lt;-</span> Sents(Path, Sent), PostProcessWithNextSentenceRules(Pattern, CovidAttribute),<span class="op">\</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>py_rgx_span(Sent, Pattern) <span class="op">-&gt;</span> (Span)</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>CovidAttributes(Path, CovidSpan, CovidAttribute, Sent1) <span class="op">&lt;-</span> CovidSpans(Path, CovidSpan, Sent1), NextSent(Path, Sent1, Sent2), PostProcessWithNextSentenceMatches(CovidAttribute, Span, Path, Sent2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="document-classifier-1" class="level4">
<h4 class="anchored" data-anchor-id="document-classifier-1">Document Classifier:</h4>
<div class="sourceCode" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> attribute_filter(group):</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'IGNORE'</span> <span class="kw">in</span> group.values:</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'IGNORE'</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'negated'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_negated'</span> <span class="kw">in</span> group.values:</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'future'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_future'</span> <span class="kw">in</span> group.values:</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'other experiencer'</span> <span class="kw">in</span> group.values <span class="kw">or</span> <span class="st">'not relevant'</span> <span class="kw">in</span> group.values:</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'positive'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'uncertain'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_positive'</span> <span class="kw">in</span> group.values:</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'positive'</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'uncertain'</span></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (magic_session.run_commands(<span class="st">"?CovidAttributes(Path, CovidSpan, CovidAttribute, Sent)"</span>, print_results<span class="op">=</span><span class="va">False</span>, format_results<span class="op">=</span><span class="va">True</span>))[<span class="dv">0</span>]</span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> DataFrame(columns<span class="op">=</span>[<span class="st">"Path"</span>,<span class="st">"CovidSpan"</span>,<span class="st">"CovidAttribute"</span>])</span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'CovidAttribute'</span>] <span class="op">=</span> df.groupby([<span class="st">'CovidSpan'</span>, <span class="st">'Sent'</span>])[<span class="st">'CovidAttribute'</span>].transform(attribute_filter)</span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.drop_duplicates().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_doc_helper(group):</span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'positive'</span> <span class="kw">in</span> group.values:</span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'POS'</span></span>
<span id="cb140-24"><a href="#cb140-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'uncertain'</span> <span class="kw">in</span> group.values:</span>
<span id="cb140-25"><a href="#cb140-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'UNK'</span></span>
<span id="cb140-26"><a href="#cb140-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'negated'</span> <span class="kw">in</span> group.values:</span>
<span id="cb140-27"><a href="#cb140-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'NEG'</span></span>
<span id="cb140-28"><a href="#cb140-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb140-29"><a href="#cb140-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'UNK'</span></span>
<span id="cb140-30"><a href="#cb140-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb140-31"><a href="#cb140-31" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'DocResult'</span>] <span class="op">=</span> df.groupby(<span class="st">'Path'</span>)[<span class="st">'CovidAttribute'</span>].transform(classify_doc_helper)</span>
<span id="cb140-32"><a href="#cb140-32" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">'Path'</span>, <span class="st">'DocResult'</span>]]</span>
<span id="cb140-33"><a href="#cb140-33" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.drop_duplicates().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb140-34"><a href="#cb140-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-35"><a href="#cb140-35" aria-hidden="true" tabindex="-1"></a>df_path <span class="op">=</span> (magic_session.run_commands(<span class="st">"?FilesPaths(Path)"</span>, print_results<span class="op">=</span><span class="va">False</span>, format_results<span class="op">=</span><span class="va">True</span>))[<span class="dv">0</span>]</span>
<span id="cb140-36"><a href="#cb140-36" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (pd.merge(df, df_path, on<span class="op">=</span><span class="st">'Path'</span>, how<span class="op">=</span><span class="st">'outer'</span>))</span>
<span id="cb140-37"><a href="#cb140-37" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'DocResult'</span>] <span class="op">=</span> df[<span class="st">'DocResult'</span>].fillna(<span class="st">"UNK"</span>)</span>
<span id="cb140-38"><a href="#cb140-38" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/DeanLight\.github\.io\/spannerlib");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/DeanLight/spannerlib/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>