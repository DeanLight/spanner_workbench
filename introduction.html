<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spannerlib - Introduction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Spannerlib - Introduction">
<meta property="og:description" content="work bench">
<meta property="og:site_name" content="Spannerlib">
<meta name="twitter:title" content="Spannerlib - Introduction">
<meta name="twitter:description" content="work bench">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Spannerlib</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./introduction.html">Tutorials</a></li><li class="breadcrumb-item"><a href="./introduction.html">Introduction</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to Spannerlib</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stdlib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Standard library ie functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced_usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced Usage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./building_your_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Building your own optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extended_version.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced IE functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./covid-nlp/covid_pipeline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Covid-19 NLP Pipeline</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">src</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Generic</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./general_utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./primitive_types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Primitive Types</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Grammar &amp; Parsing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./expected_grammar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Expected Grammar</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./symbol_table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Symbol Table</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lark_passes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lark Passes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./passes_utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Passes Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimizations_passes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimizations Passes</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Engine</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./engine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Engine</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./execution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Execution</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Graphs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ast_node_types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ast Nodes Types</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ie_function.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IE Function</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graphs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./adding_inference_rules_to_term_graph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Adding inference rules to term graph</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">User-Interface</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Session</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#using-spannerlog" id="toc-using-spannerlog" class="nav-link active" data-scroll-target="#using-spannerlog">Using spannerlog</a>
  <ul class="collapse">
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">Installation</a></li>
  </ul></li>
  <li><a href="#local-and-free-variables" id="toc-local-and-free-variables" class="nav-link" data-scroll-target="#local-and-free-variables">Local and free variables</a><a class="anchor nav-link" id="local_and_free_vars" data-scroll-target="undefined"></a></li>
  <li><a href="#local-variable-assignment" id="toc-local-variable-assignment" class="nav-link" data-scroll-target="#local-variable-assignment">Local variable assignment</a><a class="anchor nav-link" id="local_var_assignment" data-scroll-target="undefined"></a></li>
  <li><a href="#reading-from-a-file" id="toc-reading-from-a-file" class="nav-link" data-scroll-target="#reading-from-a-file">Reading from a file</a><a class="anchor nav-link" id="read_a_file" data-scroll-target="undefined"></a></li>
  <li><a href="#declaring-a-relation" id="toc-declaring-a-relation" class="nav-link" data-scroll-target="#declaring-a-relation">Declaring a relation</a><a class="anchor nav-link" id="declare_relations" data-scroll-target="undefined"></a></li>
  <li><a href="#facts" id="toc-facts" class="nav-link" data-scroll-target="#facts">Facts</a><a class="anchor nav-link" id="facts" data-scroll-target="undefined"></a></li>
  <li><a href="#rules" id="toc-rules" class="nav-link" data-scroll-target="#rules">Rules</a><a class="anchor nav-link" id="rules" data-scroll-target="undefined"></a></li>
  <li><a href="#queries" id="toc-queries" class="nav-link" data-scroll-target="#queries">Queries</a><a class="anchor nav-link" id="queries" data-scroll-target="undefined"></a>
  <ul class="collapse">
  <li><a href="#how-rules-and-queries-are-saved-in-the-database" id="toc-how-rules-and-queries-are-saved-in-the-database" class="nav-link" data-scroll-target="#how-rules-and-queries-are-saved-in-the-database">How Rules and Queries are saved in the database?</a></li>
  </ul></li>
  <li><a href="#using-ie-functions" id="toc-using-ie-functions" class="nav-link" data-scroll-target="#using-ie-functions">Using IE Functions</a>
  <ul class="collapse">
  <li><a href="#functional-regex-formulas" id="toc-functional-regex-formulas" class="nav-link" data-scroll-target="#functional-regex-formulas">Functional regex formulas</a><a class="anchor nav-link" id="RGX_ie" data-scroll-target="undefined"></a></li>
  <li><a href="#creating-and-registering-a-new-ie-function" id="toc-creating-and-registering-a-new-ie-function" class="nav-link" data-scroll-target="#creating-and-registering-a-new-ie-function">Creating and Registering a New IE Function</a><a class="anchor nav-link" id="custom_ie" data-scroll-target="undefined"></a>
  <ul class="collapse">
  <li><a href="#ie-function-get_happy" id="toc-ie-function-get_happy" class="nav-link" data-scroll-target="#ie-function-get_happy">IE function <code>get_happy</code></a></li>
  <li><a href="#custom-ie-using-get_happy" id="toc-custom-ie-using-get_happy" class="nav-link" data-scroll-target="#custom-ie-using-get_happy">custom IE using <code>get_happy</code></a></li>
  </ul></li>
  <li><a href="#more-information-about-ie-functions" id="toc-more-information-about-ie-functions" class="nav-link" data-scroll-target="#more-information-about-ie-functions">More information about IE functions</a></li>
  </ul></li>
  <li><a href="#additional-small-features" id="toc-additional-small-features" class="nav-link" data-scroll-target="#additional-small-features">Additional small features</a><a class="anchor nav-link" id="small_features" data-scroll-target="undefined"></a></li>
  <li><a href="#spannerlog-program-example" id="toc-spannerlog-program-example" class="nav-link" data-scroll-target="#spannerlog-program-example">spannerlog program example</a><a class="anchor nav-link" id="example_program" data-scroll-target="undefined"></a></li>
  <li><a href="#useful-tricks" id="toc-useful-tricks" class="nav-link" data-scroll-target="#useful-tricks">Useful tricks</a><a class="anchor nav-link" id="Usefull tricks" data-scroll-target="undefined"></a>
  <ul class="collapse">
  <li><a href="#matching-outputs" id="toc-matching-outputs" class="nav-link" data-scroll-target="#matching-outputs">Matching Outputs:</a>
  <ul class="collapse">
  <li><a href="#first-try" id="toc-first-try" class="nav-link" data-scroll-target="#first-try">First try:</a></li>
  <li><a href="#it-works" id="toc-it-works" class="nav-link" data-scroll-target="#it-works">It works</a></li>
  <li><a href="#it-looks-good-but-why" id="toc-it-looks-good-but-why" class="nav-link" data-scroll-target="#it-looks-good-but-why">It looks good, but why?</a></li>
  </ul></li>
  <li><a href="#logical-operators" id="toc-logical-operators" class="nav-link" data-scroll-target="#logical-operators">Logical Operators:</a></li>
  </ul></li>
  <li><a href="#python-implementation-v.s.-spannerlog-implementation" id="toc-python-implementation-v.s.-spannerlog-implementation" class="nav-link" data-scroll-target="#python-implementation-v.s.-spannerlog-implementation">Python Implementation v.s. spannerlog Implementation</a>
  <ul class="collapse">
  <li><a href="#python" id="toc-python" class="nav-link" data-scroll-target="#python">python</a></li>
  <li><a href="#spannerlog" id="toc-spannerlog" class="nav-link" data-scroll-target="#spannerlog">spannerlog</a></li>
  </ul></li>
  <li><a href="#parsing-json-document-using-spannerlog" id="toc-parsing-json-document-using-spannerlog" class="nav-link" data-scroll-target="#parsing-json-document-using-spannerlog">Parsing JSON document using spannerlog</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/DeanLight/spannerlib/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./introduction.html">Tutorials</a></li><li class="breadcrumb-item"><a href="./introduction.html">Introduction</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Introduction</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>this project is built with nbdev, which is a full literate programming environment built on Jupyter Notebooks. That means that every piece of documentation, including the page you’re reading now, can be accessed as interactive Jupyter notebook. <br> <a href="https://colab.research.google.com/github/DeanLight/spannerlib/blob/master/nbs/introduction.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" class="img-fluid" alt="Open In Colab"></a></p>
</div>
</div>
<section id="using-spannerlog" class="level2">
<h2 class="anchored" data-anchor-id="using-spannerlog">Using spannerlog</h2>
<section id="installation" class="level3">
<h3 class="anchored" data-anchor-id="installation">Installation</h3>
<p>prerequisites:</p>
<ul>
<li>Have <a href="https://www.python.org/downloads/">Python</a> version 3.8 or above installed</li>
</ul>
<p>To download and install spannerlog run the following commands in your terminal:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/DeanLight/spannerlib</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> spannerlib</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install . </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Make sure you are calling the pip version of your current python environment. To install with another python interpreter, run</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>path_to_python_interpreter<span class="op">&gt;</span> -m <span class="ex">pip</span> install .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can also install spannerlog in the current Jupyter kernel: <!-- #endregion --></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>git clone https:<span class="op">//</span>github.com<span class="op">/</span>DeanLight<span class="op">/</span>spannerlib</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install spannerlib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In order to use spannerlog in jupyter notebooks, you must first load it:</p>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spannerlib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Importing the spannerlog library automatically loads the <code>%spannerlog</code> and <code>%%spannerlog</code> cell magics which accepts spannerlog queries as shown below.</p>
<p>use <code>%spannerlog</code> to run a single line, and <code>%%spannerlog</code> to run a block of code:</p>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>spannerlog new relation(<span class="bu">str</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"this is python code"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>this is python code</code></pre>
</div>
</div>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>new uncle(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>uncle(<span class="st">"bob"</span>, <span class="st">"greg"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>?uncle(X,Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'uncle(X, Y)':
  X  |  Y
-----+------
 bob | greg
</code></pre>
</div>
</div>
</section>
</section>
<section id="local-and-free-variables" class="level1">
<h1>Local and free variables<a class="anchor" id="local_and_free_vars"></a></h1>
<p>spannerlog distinguishes two kinds of variables.</p>
<p>The first kind are local variables. These are variables that store a single value (e.g.&nbsp;string). They work similarly to variables in python. A local variable must be defined via assignment before being used.</p>
<p>A local variable name must begin with a lowercase letter or with an underscore (_), and can be continued with letters, digits and underscores</p>
<p>Here are some examples for legal local variable names: * <code>a</code> * <code>a_name123</code> * <code>_Some_STRING</code></p>
<p>And here are some illegal local variable names: * <code>A</code> * <code>A_name</code> * <code>1_a</code></p>
<p>The second kind of variables are free variables. Free variables do not hold any value and are used to define relations inside <a href="#queries">queries</a> and <a href="#rules">rules</a>. Free variables do not need to be declared or defined before being used.</p>
<p>A free variable name must begin with an uppercase letter and can be continued with letters, digits and underscores</p>
<p>Here are some examples for legal free variable names: * <code>A</code> * <code>A_name</code></p>
<p>And here are some illegal free variable names: * <code>a</code> * <code>a_name</code> * <code>_Some_STRING</code> * <code>1A</code></p>
</section>
<section id="local-variable-assignment" class="level1">
<h1>Local variable assignment<a class="anchor" id="local_var_assignment"></a></h1>
<p>spannerlog allows you to use three types of variables: strings, integers and spans. The assignment of a string is intuitive:</p>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="st">"bob"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>b2 <span class="op">=</span> b <span class="co">#r b2's value is "bob"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># you can write multiline strings using a line overflow escape like in python</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>b3 <span class="op">=</span> <span class="st">"this is a multiline  </span><span class="ch">\</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="st">string"</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>b4 <span class="op">=</span> <span class="st">"this is a multiline string"</span> <span class="co"># b4 holds the same value as b3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The assignment of integers is also very simple:</p>
<div id="cell-19" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>n2 <span class="op">=</span> n <span class="co"># n2 = 4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A span identifies a substring of a string by specifying its bounding indices. It is constructed from two integers. You can assign a span value like this:</p>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>span1 <span class="op">=</span> [<span class="dv">3</span>,<span class="dv">7</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>span2 <span class="op">=</span> span1 <span class="co"># span2 value is [3,7)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="reading-from-a-file" class="level1">
<h1>Reading from a file<a class="anchor" id="read_a_file"></a></h1>
<p>You can also perform a string assignment by reading from a file. You will need to provide a path to a file by either using a string literal or a string variable:</p>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> read(<span class="st">"../README.md"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="st">"../README.md"</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> read(b) <span class="co"># c holds the same string value as a</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="declaring-a-relation" class="level1">
<h1>Declaring a relation<a class="anchor" id="declare_relations"></a></h1>
<p>spannerlog allows you to define and query relations. You have to declare a relation before you can use it (unless you define it with a rule as we’ll see in the “rules” chapter). Each term in a relation could be a string, an integer or a span. Here are some examples for declaring relations:</p>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 'brothers' is a relation with two string terms.</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>new brothers(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 'confused' is a relation with one string term.</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>new confused(<span class="bu">str</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 'animal' is a relation with one string term and one span term </span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>new animal(<span class="bu">str</span>, span)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 'scores' is a relation with one string term and one int term</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>new scores(<span class="bu">str</span>, <span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Whenever a relation is defined, a corresponding empty table is created in the database. <br> The table has the same name as the relation, and its number of columns is equal to the number of variables in the relation.</p>
</section>
<section id="facts" class="level1">
<h1>Facts<a class="anchor" id="facts"></a></h1>
<p>spannerlog is an extension of Datalog, a declarative logic programming language. In Datalog you can declare “facts”, essentially adding tuples to a relation. To do it you use the following syntax:</p>
<pre><code>relation_name(term_1,term_2,...term_3)</code></pre>
<p>or</p>
<pre><code>relation_name(term_1,term_2,...term_3) &lt;- True</code></pre>
<p>where each <code>term</code> is either a constant or a local variable that is from the same variable type that was declared for <code>relation_name</code> at the same location.</p>
<p>For example:</p>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># first declare the relation that you want to use</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>new noun(<span class="bu">str</span>, span)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># now you can add facts (tuples) to that relation</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># this span indicates that a noun "Life" can be found at indexes 0 to 3</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>noun(<span class="st">"Life finds a way"</span>, [<span class="dv">0</span>,<span class="dv">4</span>)) </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># another example</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>new sisters(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>sisters(<span class="st">"alice"</span>, <span class="st">"rin"</span>) <span class="op">&lt;-</span> <span class="va">True</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># sisters([0,4), "rin") # illegal as [0,4) is not a string</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You could also remove a fact using a similar syntax:</p>
<p><code>relation_name(term_1,term_2,...term_3) &lt;- False</code></p>
<p>if a fact that you try to remove does not exist, the remove fact statement will be silently ignored</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>new goals(<span class="bu">str</span>, <span class="bu">int</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>goals(<span class="st">"kronovi"</span>, <span class="dv">10</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>goals(<span class="st">"kronovi"</span>, <span class="dv">10</span>) <span class="op">&lt;-</span> <span class="va">False</span>  <span class="co"># 'goals' relation is now empty</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>goals(<span class="st">"kronovi"</span>, <span class="dv">10</span>) <span class="op">&lt;-</span> <span class="va">False</span>  <span class="co"># this statement does nothing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When adding or removing facts from a relation, the relation’s corresponding table in the database gets updated respectively</p>
</section>
<section id="rules" class="level1">
<h1>Rules<a class="anchor" id="rules"></a></h1>
<p>Datalog allows you to deduce new tuples for a relation. spannerlog includes this feature as well:</p>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>new parent(<span class="bu">str</span> ,<span class="bu">str</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>parent(<span class="st">"bob"</span>, <span class="st">"greg"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>parent(<span class="st">"greg"</span>, <span class="st">"alice"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># now add a rule that deduces that bob is a grandparent of alice</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>grandparent(X,Z) <span class="op">&lt;-</span> parent(X,Y), parent(Y,Z) <span class="co"># ',' is a short hand to the 'and' operator</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>spannerlog also supports recursive rules:</p>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>parent(<span class="st">"Liam"</span>, <span class="st">"Noah"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>parent(<span class="st">"Noah"</span>, <span class="st">"Oliver"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>parent(<span class="st">"James"</span>, <span class="st">"Lucas"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>parent(<span class="st">"Noah"</span>, <span class="st">"Benjamin"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>parent(<span class="st">"Benjamin"</span>, <span class="st">"Mason"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>ancestor(X,Y) <span class="op">&lt;-</span> parent(X,Y)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a recursive rule</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>ancestor(X,Y) <span class="op">&lt;-</span> parent(X,Z), ancestor(Z,Y)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Queries are explained in the next section</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>?ancestor(<span class="st">"Liam"</span>, X)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>?ancestor(X, <span class="st">"Mason"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>?ancestor(<span class="st">"Mason"</span>, X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'ancestor("Liam", X)':
    X
----------
 Benjamin
  Mason
   Noah
  Oliver

printing results for query 'ancestor(X, "Mason")':
    X
----------
 Benjamin
   Liam
   Noah

printing results for query 'ancestor("Mason", X)':
[]
</code></pre>
</div>
</div>
<p>You could also remove a rule via the session:</p>
<p><code>magic_session.remove_rule(rule_to_delete)</code></p>
<p>note: the rule must be written exactly as it appears in the output of <code>print_all_rules</code></p>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>confused(<span class="st">"Josh"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>brothers(<span class="st">"Drake"</span>, <span class="st">"Josh"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># oops! this rule was added by mistake!</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>ancestor(X, Y) <span class="op">&lt;-</span> brothers(X, Y), confused(Y)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>?ancestor(X,Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'ancestor(X, Y)':
    X     |    Y
----------+----------
 Benjamin |  Mason
  Drake   |   Josh
  James   |  Lucas
   Liam   | Benjamin
   Liam   |  Mason
   Liam   |   Noah
   Liam   |  Oliver
   Noah   | Benjamin
   Noah   |  Mason
   Noah   |  Oliver
   bob    |  alice
   bob    |   greg
   greg   |  alice
</code></pre>
</div>
</div>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib <span class="im">import</span> magic_session</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remove the rule from the current session</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">"before:"</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>magic_session.print_all_rules()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>magic_session.remove_rule(<span class="st">"ancestor(X, Y) &lt;- brothers(X, Y), confused(Y)"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">"after:"</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>magic_session.print_all_rules()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>before:
Printing all the rules:
    1. enrolled_in_chemistry(X) &lt;- enrolled(X, "chemistry")
    2. enrolled_in_physics_and_chemistry(X) &lt;- enrolled_in_chemistry(X), enrolled(X, "physics")
    3. lecturer_of(X, Z) &lt;- lecturer(X, Y), enrolled(Z, Y)
    4. student_gpas(Student, Grade) &lt;- py_rgx_string("abigail 100 jordan 80 gale 79 howard 60", "(\w+).*?(\d+)") -&gt; (Student, Grade)
    5. happy_students_with_sad_lecturers_and_their_gpas(Student, Grade, Lecturer) &lt;- documents(Doc), get_happy(Doc) -&gt; (Student), sad_lecturers(Lecturer), lecturer_of(Lecturer, Student), student_gpas(Student, Grade)
    6. grandparent(X, Z) &lt;- parent(X, Y), parent(Y, Z)
    7. ancestor(X, Y) &lt;- parent(X, Y)
    8. ancestor(X, Y) &lt;- parent(X, Z), ancestor(Z, Y)
    9. ancestor(X, Y) &lt;- brothers(X, Y), confused(Y)
after:
Printing all the rules:
    1. enrolled_in_chemistry(X) &lt;- enrolled(X, "chemistry")
    2. enrolled_in_physics_and_chemistry(X) &lt;- enrolled_in_chemistry(X), enrolled(X, "physics")
    3. lecturer_of(X, Z) &lt;- lecturer(X, Y), enrolled(Z, Y)
    4. student_gpas(Student, Grade) &lt;- py_rgx_string("abigail 100 jordan 80 gale 79 howard 60", "(\w+).*?(\d+)") -&gt; (Student, Grade)
    5. happy_students_with_sad_lecturers_and_their_gpas(Student, Grade, Lecturer) &lt;- documents(Doc), get_happy(Doc) -&gt; (Student), sad_lecturers(Lecturer), lecturer_of(Lecturer, Student), student_gpas(Student, Grade)
    6. grandparent(X, Z) &lt;- parent(X, Y), parent(Y, Z)
    7. ancestor(X, Y) &lt;- parent(X, Y)
    8. ancestor(X, Y) &lt;- parent(X, Z), ancestor(Z, Y)</code></pre>
</div>
</div>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>?ancestor(X,Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'ancestor(X, Y)':
    X     |    Y
----------+----------
 Benjamin |  Mason
  James   |  Lucas
   Liam   | Benjamin
   Liam   |  Mason
   Liam   |   Noah
   Liam   |  Oliver
   Noah   | Benjamin
   Noah   |  Mason
   Noah   |  Oliver
   bob    |  alice
   bob    |   greg
   greg   |  alice
</code></pre>
</div>
</div>
<p>success! the rule was deleted - Drake and Josh are no longer part of the <code>?ancestor</code> query result</p>
<p>Note that during this examples we used <a href="https://DeanLight.github.io/spannerlib/session.html#print_all_rules"><code>print_all_rules</code></a>.<br> This function prints all the registered rules.<br> If you wan’t to print only rules that relevant to spesific rule head, you can pass the rule head as a parameter.</p>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>magic_session.print_all_rules(<span class="st">"ancestor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Printing all the rules with head ancestor:
    1. ancestor(X, Y) &lt;- parent(X, Y)
    2. ancestor(X, Y) &lt;- parent(X, Z), ancestor(Z, Y)</code></pre>
</div>
</div>
<p>In addition you can use <a href="https://DeanLight.github.io/spannerlib/session.html#remove_all_rules"><code>remove_all_rules</code></a> to remove all the rules (it won’t affect the facts).<br> You can pass rule head paraemetr to remove all the rules related to it.</p>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>magic_session.remove_all_rules(<span class="st">"ancestor"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"after removing ancestor rules:"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>magic_session.print_all_rules()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>magic_session.remove_all_rules()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"after removing all rules:"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>magic_session.print_all_rules()</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># facts are not affected...</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>spannerlog ?parent(X, Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>after removing ancestor rules:
Printing all the rules:
    1. enrolled_in_chemistry(X) &lt;- enrolled(X, "chemistry")
    2. enrolled_in_physics_and_chemistry(X) &lt;- enrolled_in_chemistry(X), enrolled(X, "physics")
    3. lecturer_of(X, Z) &lt;- lecturer(X, Y), enrolled(Z, Y)
    4. student_gpas(Student, Grade) &lt;- py_rgx_string("abigail 100 jordan 80 gale 79 howard 60", "(\w+).*?(\d+)") -&gt; (Student, Grade)
    5. happy_students_with_sad_lecturers_and_their_gpas(Student, Grade, Lecturer) &lt;- documents(Doc), get_happy(Doc) -&gt; (Student), sad_lecturers(Lecturer), lecturer_of(Lecturer, Student), student_gpas(Student, Grade)
    6. grandparent(X, Z) &lt;- parent(X, Y), parent(Y, Z)
after removing all rules:
Printing all the rules:
printing results for query 'parent(X, Y)':
    X     |    Y
----------+----------
   bob    |   greg
   greg   |  alice
   Liam   |   Noah
   Noah   |  Oliver
  James   |  Lucas
   Noah   | Benjamin
 Benjamin |  Mason
</code></pre>
</div>
</div>
</section>
<section id="queries" class="level1">
<h1>Queries<a class="anchor" id="queries"></a></h1>
<p>A query is essentially a way to retrieve specific information from a dataset. <br> querying in spannerlog uses the same synatx and semantics as DataLog. <br> Under said semantics, we try to find all instantiations of free variables that satisfy the queried relation.</p>
<p>You can query by using constant values, local variables and free variables:</p>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># first create a relation with some facts for the example</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>new grandfather(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># bob and george are the grandfathers of alice and rin</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>grandfather(<span class="st">"bob"</span>, <span class="st">"alice"</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>grandfather(<span class="st">"bob"</span>, <span class="st">"rin"</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>grandfather(<span class="st">"george"</span>, <span class="st">"alice"</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>grandfather(<span class="st">"george"</span>, <span class="st">"rin"</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># edward is the grandfather of john</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>grandfather(<span class="st">"edward"</span>, <span class="st">"john"</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># now for the queries</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>?grandfather(<span class="st">"bob"</span>, <span class="st">"alice"</span>) <span class="co"># returns an empty tuple () as alice is bob's grandchild</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>?grandfather(<span class="st">"edward"</span>, <span class="st">"alice"</span>) <span class="co"># returns nothing as alice is not edward's grandchild</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>?grandfather(<span class="st">"george"</span>, X) <span class="co"># returns "rin" and "alice" as both rin</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># and alice are george's grandchildren</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>?grandfather(X, <span class="st">"rin"</span>) <span class="co"># returns "bob" and "george" (rin's grandfathers)</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>?grandfather(X, Y) <span class="co"># returns all the tuples in the 'grandfather' relation</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>new verb(<span class="bu">str</span>, span)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>verb(<span class="st">"Ron eats quickly."</span>, [<span class="dv">4</span>,<span class="dv">8</span>))</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>verb(<span class="st">"You write neatly."</span>, [<span class="dv">4</span>,<span class="dv">9</span>))</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>?verb(<span class="st">"Ron eats quickly."</span>, X) <span class="co"># returns [4,8)</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>?verb(X,[<span class="dv">4</span>,<span class="dv">9</span>)) <span class="co"># returns "You write neatly."</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>new orders(<span class="bu">str</span>, <span class="bu">int</span>)</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>orders(<span class="st">"pie"</span>, <span class="dv">4</span>)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>orders(<span class="st">"pizza"</span>, <span class="dv">4</span>)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>orders(<span class="st">"cake"</span>, <span class="dv">0</span>)</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>?orders(X, <span class="dv">4</span>) <span class="co"># retutns "pie" and "pizza"         </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'grandfather("bob", "alice")':
[()]

printing results for query 'grandfather("edward", "alice")':
[]

printing results for query 'grandfather("george", X)':
   X
-------
 alice
  rin

printing results for query 'grandfather(X, "rin")':
   X
--------
  bob
 george

printing results for query 'grandfather(X, Y)':
   X    |   Y
--------+-------
  bob   | alice
  bob   |  rin
 george | alice
 george |  rin
 edward | john

printing results for query 'verb("Ron eats quickly.", X)':
   X
--------
 [4, 8)

printing results for query 'verb(X, [4, 9))':
         X
-------------------
 You write neatly.

printing results for query 'orders(X, 4)':
   X
-------
  pie
 pizza
</code></pre>
</div>
</div>
<p>You may have noticed that the query</p>
<pre><code>?grandfather("bob", "alice")</code></pre>
<p>returns an empty tuple. This is because of the fact that bob is alice’s grandfather is true, our query has no free variables, which means it asks a specific factual question about the dataset. If the query is true, it means the specified condition exists in the dataset. If false, it means the condition does not exist. And this is why if we have a query with no free variables, we get an empty set of instantiations if its true and no such set if its false.</p>
<p>A good example for using free variables to construct a relation is the query:</p>
<pre><code>?grandfather("george", X)</code></pre>
<p>which finds all of george’s grandchildren (<code>X</code>) and constructs a tuple for each one.</p>
<section id="how-rules-and-queries-are-saved-in-the-database" class="level3">
<h3 class="anchored" data-anchor-id="how-rules-and-queries-are-saved-in-the-database">How Rules and Queries are saved in the database?</h3>
<p>Unlike facts, which are immediately stored in the database upon their creation, rules are not computed and added to the database upon declaration. Instead, the logic of a rule is saved separately and is only evaluated when needed (lazy evaluation). When a query is made, the engine utilizes these rules to derive all potential solutions from the existing facts that would fulfill the query.</p>
</section>
</section>
<section id="using-ie-functions" class="level1">
<h1>Using IE Functions</h1>
<section id="functional-regex-formulas" class="level2">
<h2 class="anchored" data-anchor-id="functional-regex-formulas">Functional regex formulas<a class="anchor" id="RGX_ie"></a></h2>
<p>spannerlog contains IE functions which are registered by default. Let’s go over a couple regex IE functions:</p>
<pre><code>rgx_span(regex_input ,regex_formula)-&gt;(x_1, x_2, ...,x_n)</code></pre>
<p>and</p>
<pre><code>rgx_string(regex_input ,regex_formula)-&gt;(x_1, x_2, ...,x_n)</code></pre>
<p>where: * <code>regex_input</code> is the string that the regex operation will be performed on * <code>regex_formula</code> is either a string literal or a string variable that represents your regular expression. * <code>x_1</code>, <code>x_2</code>, … <code>x_n</code> can be either constant terms or free variable terms. They’re used to construct the tuples of the resulting relation. the number of terms has to be the same as the number of capture groups used in <code>regex_formula</code>. If not capture groups are used, then each returned tuple includes a single, whole regex match, so only one term should be used.</p>
<p>The only difference between the <a href="https://DeanLight.github.io/spannerlib/ie_func/rust_spanner_regex.html#rgx_span"><code>rgx_span</code></a> and <a href="https://DeanLight.github.io/spannerlib/ie_func/rust_spanner_regex.html#rgx_string"><code>rgx_string</code></a> ie functions, is that rgx_string returns strings, while rgx_span returns the spans of those strings. This also means that if you want to use constant terms as return values, they have to be spans if you use <a href="https://DeanLight.github.io/spannerlib/ie_func/rust_spanner_regex.html#rgx_span"><code>rgx_span</code></a>, and strings if you use <a href="https://DeanLight.github.io/spannerlib/ie_func/rust_spanner_regex.html#rgx_string"><code>rgx_string</code></a></p>
<p>For example consider the following spannerlog code:</p>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>input_string <span class="op">=</span> <span class="st">"John Doe: 35 years old, Jane Smith: 28 years old"</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>regex_pattern <span class="op">=</span> <span class="st">"(\w+\s\w+):\s(\d+)"</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>age(X,Y) <span class="op">&lt;-</span> py_rgx_string(input_string, regex_pattern) <span class="op">-&gt;</span> (X,Y)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>age_span(X,Y) <span class="op">&lt;-</span> py_rgx_span(input_string, regex_pattern) <span class="op">-&gt;</span> (X,Y)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>?age(X,Y)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>?age_span(X,Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'age(X, Y)':
     X      |   Y
------------+-----
  John Doe  |  35
 Jane Smith |  28

printing results for query 'age_span(X, Y)':
    X     |    Y
----------+----------
  [0, 8)  | [10, 12)
 [24, 34) | [36, 38)
</code></pre>
</div>
</div>
<p>The variables X,Y in the output of the above ie functions are the matches of the capture groups used in the regex_pattern. <br> capture groups allow us to extract specific parts of a matched pattern in a text using regular expressions. <br> When you define a regular expression pattern with parentheses (), you create a capturing group</p>
</section>
<section id="creating-and-registering-a-new-ie-function" class="level2">
<h2 class="anchored" data-anchor-id="creating-and-registering-a-new-ie-function">Creating and Registering a New IE Function<a class="anchor" id="custom_ie"></a></h2>
<p>Using regex is nice, but what if you want to define your own IE function? <br> spannerlog allows you to define and use your own information extraction functions. You can use them only in rule bodies in the current version. The following is the syntax for custom IE functions:</p>
<pre><code>func(term_1,term_2,...term_n)-&gt;(x_1, x_2, ..., x_n)</code></pre>
<p>where: * <code>func</code> is a IE function that was previously defined and registered * <code>term_1</code>,<code>term_2</code>,…,<code>term_n</code> are the parameters for func * <code>x_1</code>, … <code>x_n</code> could be any type of terms, and are used to construct tuples of the resulting relation</p>
<p>For example:</p>
<section id="ie-function-get_happy" class="level3">
<h3 class="anchored" data-anchor-id="ie-function-get_happy">IE function <code>get_happy</code></h3>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib.primitive_types <span class="im">import</span> DataTypes</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the function itself, which should yield an iterable of primitive types</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_happy(text):</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">    get the names of people who are happy in `text`</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    compiled_rgx <span class="op">=</span> re.<span class="bu">compile</span>(<span class="st">"(\w+) is happy"</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    num_groups <span class="op">=</span> compiled_rgx.groups</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> match <span class="kw">in</span> re.finditer(compiled_rgx, text):</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_groups <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>            matched_strings <span class="op">=</span> [match.group()]</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>            matched_strings <span class="op">=</span> [group <span class="cf">for</span> group <span class="kw">in</span> match.groups()]</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> matched_strings</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="co"># the input types, a list of primitive types</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>get_happy_in_types <span class="op">=</span> [DataTypes.string]</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="co"># the output types, either a list of primitive types or </span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="co"># a method which expects an arity and computes the desired types based on it</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>get_happy_out_types <span class="op">=</span> <span class="kw">lambda</span> arity : arity <span class="op">*</span> [DataTypes.string]</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co"># or: `get_happy_out_types = [DataTypes.string]`s</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="co"># finally, register the function</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>magic_session.register(ie_function<span class="op">=</span>get_happy,</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>                       ie_function_name <span class="op">=</span> <span class="st">"get_happy"</span>,</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>                       in_rel<span class="op">=</span>get_happy_in_types,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>                       out_rel<span class="op">=</span>get_happy_out_types)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You may have noticed that when we register a custom ie function, we use <code>yield</code> instead of <code>return</code>, <br> and that is because part of making spanner based database systems more performant and memory efficient is to do lazy evaluation, <br> since building iterators in python is very simple using the generator pattern, we made the ie functions into generators to allow ie functions to also be as lazy as their author desires.</p>
</section>
<section id="custom-ie-using-get_happy" class="level3">
<h3 class="anchored" data-anchor-id="custom-ie-using-get_happy">custom IE using <code>get_happy</code></h3>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>new grandmother(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>grandmother(<span class="st">"rin"</span>, <span class="st">"alice"</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>grandmother(<span class="st">"denna"</span>, <span class="st">"joel"</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>sentence <span class="op">=</span> <span class="st">"rin is happy, denna is sad."</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># note that this statement will fail as 'get_happy' is not registered as an ie_function</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>happy_grandmother(X) <span class="op">&lt;-</span> grandmother(X,Z),get_happy(sentence)<span class="op">-&gt;</span>(X)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>?happy_grandmother(X) <span class="co"># assuming get_happy returned "rin", also returns "rin"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'happy_grandmother(X)':
  X
-----
 rin
</code></pre>
</div>
</div>
</section>
</section>
<section id="more-information-about-ie-functions" class="level2">
<h2 class="anchored" data-anchor-id="more-information-about-ie-functions">More information about IE functions</h2>
<ul>
<li>You can remove an IE function via the session:</li>
</ul>
<p><code>magic_session.remove_ie_function(ie_function_name)</code></p>
<ul>
<li>If you want to remove all the registered ie functions:</li>
</ul>
<p><code>magic_session.remove_all_ie_functions()</code></p>
<ul>
<li>If you register an IE function with a name that was already registered before, the old IE function will be overwitten by the new one. <br><br></li>
<li>You can inspect all the registered IE functions using the following command:</li>
</ul>
<p><code>magic_session.print_registered_ie_functions()</code></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first, let's print all functions:</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>magic_session.print_registered_ie_functions()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>another tremendous triumph! Coref was deleted from the registered functions</p>
</section>
</section>
<section id="additional-small-features" class="level1">
<h1>Additional small features<a class="anchor" id="small_features"></a></h1>
<p>You can use line overflow escapes if you want to split your statements into multiple lines</p>
<p><code>python pycharm={"name": "#%%\n"} %%spannerlog k \ = "some \ string"</code></p>
</section>
<section id="spannerlog-program-example" class="level1">
<h1>spannerlog program example<a class="anchor" id="example_program"></a></h1>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spannerlib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>new lecturer(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>lecturer(<span class="st">"walter"</span>, <span class="st">"chemistry"</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>lecturer(<span class="st">"linus"</span>, <span class="st">"operation systems"</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>lecturer(<span class="st">"rick"</span>, <span class="st">"physics"</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>new enrolled(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>enrolled(<span class="st">"abigail"</span>, <span class="st">"chemistry"</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>enrolled(<span class="st">"abigail"</span>, <span class="st">"operation systems"</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>enrolled(<span class="st">"jordan"</span>, <span class="st">"chemistry"</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>enrolled(<span class="st">"gale"</span>, <span class="st">"operation systems"</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>enrolled(<span class="st">"howard"</span>, <span class="st">"chemistry"</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>enrolled(<span class="st">"howard"</span>, <span class="st">"physics"</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>enrolled_in_chemistry(X) <span class="op">&lt;-</span> enrolled(X, <span class="st">"chemistry"</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>?enrolled_in_chemistry(<span class="st">"jordan"</span>) <span class="co"># returns empty tuple ()</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>?enrolled_in_chemistry(<span class="st">"gale"</span>) <span class="co"># returns nothing</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>?enrolled_in_chemistry(X) <span class="co"># returns "abigail", "jordan" and "howard"</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>enrolled_in_physics_and_chemistry(X) <span class="op">&lt;-</span> enrolled_in_chemistry(X), enrolled(X, <span class="st">"physics"</span>)</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>?enrolled_in_physics_and_chemistry(X) <span class="co"># returns "howard"</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>lecturer_of(X,Z) <span class="op">&lt;-</span> lecturer(X,Y), enrolled(Z,Y)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>?lecturer_of(X,<span class="st">"abigail"</span>) <span class="co"># returns "walter" and "linus"</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>grade_str <span class="op">=</span> <span class="st">"abigail 100 jordan 80 gale 79 howard 60"</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>grade_of_chemistry_students(Student, Grade) <span class="op">&lt;-</span> <span class="op">\</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>py_rgx_string(grade_str, <span class="st">"(\w+).*?(\d+)"</span>)<span class="op">-&gt;</span>(Student, Grade), enrolled_in_chemistry(Student)</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>?grade_of_chemistry_students(X, <span class="st">"100"</span>) <span class="co"># returns "abigail"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Exception: relation "lecturer" already has a schema</code></pre>
</div>
</div>
</section>
<section id="useful-tricks" class="level1">
<h1>Useful tricks<a class="anchor" id="Usefull tricks"></a></h1>
<section id="matching-outputs" class="level2">
<h2 class="anchored" data-anchor-id="matching-outputs">Matching Outputs:</h2>
<p>Let’s write a spannerlog program that gets a table in which each row is a single string - string(str). <br> The program will create a new table in which each row is a string and its length.</p>
<section id="first-try" class="level3">
<h3 class="anchored" data-anchor-id="first-try">First try:</h3>
<div id="cell-65" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: implement an IE function</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> length(string):</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#here we append the input to the output inside the ie function!</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="bu">len</span>(string), string</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>magic_session.register(length, <span class="st">"Length"</span>, [DataTypes.string], [DataTypes.integer, DataTypes.string])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-66" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's test this solution:</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>new string(<span class="bu">str</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>string(<span class="st">"a"</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>string(<span class="st">"ab"</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>string(<span class="st">"abc"</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>string(<span class="st">"abcd"</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>string_length(Str, Len) <span class="op">&lt;-</span> string(Str), Length(Str) <span class="op">-&gt;</span> (Len, Str)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>?string_length(Str, Len)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'string_length(Str, Len)':
  Str  |   Len
-------+-------
   a   |     1
  ab   |     2
  abc  |     3
 abcd  |     4
</code></pre>
</div>
</div>
</section>
<section id="it-works" class="level3">
<h3 class="anchored" data-anchor-id="it-works">It works</h3>
<p>Our first IE function yield the input in addition to the output. This will ensure that we will get the right output to his input. But, is this really necessary? Let’s try another solution:</p>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#here we don't append the input to the output inside the ie function!</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> length2(string):</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>   <span class="cf">yield</span> <span class="bu">len</span>(string),</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: register the function</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>magic_session.register(length2, <span class="st">"Length2"</span>, [DataTypes.string], [DataTypes.integer])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's test this solution:</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>new rel(<span class="bu">str</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>rel(<span class="st">"a"</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>rel(<span class="st">"ab"</span>)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>rel(<span class="st">"abc"</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>rel(<span class="st">"abcd"</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>string_length(Str, Len) <span class="op">&lt;-</span> rel(Str), Length2(Str) <span class="op">-&gt;</span> (Len)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>?string_length(Str, Len)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'string_length(Str, Len)':
  Str  |   Len
-------+-------
   a   |     1
  ab   |     2
  abc  |     3
 abcd  |     4
</code></pre>
</div>
</div>
</section>
<section id="it-looks-good-but-why" class="level3">
<h3 class="anchored" data-anchor-id="it-looks-good-but-why">It looks good, but why?</h3>
<p>First we can see that the IE function yield only an output without any trace to the input. In addition, spannerlog stores all the inputs of each IE function in an input table and all the outputs in an output table. Then it’s joining the input table with the output table. So, why we still got the right solution? This thanks to the fact that spannerlog stores the input bounded to it’s output deductively.</p>
</section>
</section>
<section id="logical-operators" class="level2">
<h2 class="anchored" data-anchor-id="logical-operators">Logical Operators:</h2>
<p>Suppose we have a table in which each row contains two strings - pair(str, str). Our goal is to filter all the rows that contain the same value twice. <br> In other words, we want to implement the relation <strong>not equals (NEQ)</strong>.</p>
<p>We would like to have a rule such as: <br> <code>unique_pair(X, Y) &lt;- pair(X, Y), X != Y</code> <br><br> Unfortunately spannerlog doesn’t support True/False values. Therefore, we can’t use <code>X != Y</code>. <br> Our solution to this problem is to create an ie function that implements NEQ relation:</p>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> NEQ(x, y):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">==</span> y:</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return false (empty tuple represents false)</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> <span class="bu">tuple</span>() </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">#return true</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> x, y</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>in_out_types <span class="op">=</span> [DataTypes.string, DataTypes.string]</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>magic_session.register(NEQ, <span class="st">"NEQ"</span>, in_out_types, in_out_types)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Lets test this solution</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>new pair(<span class="bu">str</span>, <span class="bu">str</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>pair(<span class="st">"Dan"</span>, <span class="st">"Tom"</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>pair(<span class="st">"Cat"</span>, <span class="st">"Dog"</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>pair(<span class="st">"Apple"</span>, <span class="st">"Apple"</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>pair(<span class="st">"Cow"</span>, <span class="st">"Cow"</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>pair(<span class="st">"123"</span>, <span class="st">"321"</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>unique_pair(X, Y) <span class="op">&lt;-</span> pair(X, Y), NEQ(X, Y) <span class="op">-&gt;</span> (X, Y)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>?unique_pair(X, Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'unique_pair(X, Y)':
  X  |  Y
-----+-----
 Dan | Tom
 Cat | Dog
 123 | 321
</code></pre>
</div>
</div>
</section>
</section>
<section id="python-implementation-v.s.-spannerlog-implementation" class="level1">
<h1>Python Implementation v.s. spannerlog Implementation</h1>
<p>let’s try to compare coding in python and coding in spannerlog. we are given two long strings of enrolled pairs, grades pairs. our goal is to find all student that are enrolled in biology and chemistry, and have a GPA = 80.</p>
<section id="python" class="level2">
<h2 class="anchored" data-anchor-id="python">python</h2>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>enrolled <span class="op">=</span> <span class="st">"dave chemistry dave biology rem biology ram biology emilia physics roswaal chemistry roswaal biology roswaal physics"</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>grades <span class="op">=</span> <span class="st">"dave 80 rem 66 ram 66 roswaal 100 emilia 88"</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>enrolled_pairs <span class="op">=</span> re.findall(<span class="vs">r"(\w+).*?(\w+)"</span>, enrolled)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>grade_pairs <span class="op">=</span> re.findall(<span class="vs">r"(\w+).*?(\d+)"</span>, grades)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> student1, course1 <span class="kw">in</span> enrolled_pairs:</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> student2, course2 <span class="kw">in</span> enrolled_pairs:</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> student3, grade <span class="kw">in</span> grade_pairs:</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (student1 <span class="op">==</span> student2 <span class="op">==</span> student3):</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (course1 <span class="op">==</span> <span class="st">"biology"</span> <span class="kw">and</span> course2 <span class="op">==</span> <span class="st">"chemistry"</span> <span class="kw">and</span> <span class="bu">int</span>(grade) <span class="op">==</span> <span class="dv">80</span>):</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(student1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dave</code></pre>
</div>
</div>
</section>
<section id="spannerlog" class="level2">
<h2 class="anchored" data-anchor-id="spannerlog">spannerlog</h2>
<div id="cell-78" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>enrolled <span class="op">=</span> <span class="st">"dave chemistry dave biology rem biology ram biology emilia physics roswaal chemistry roswaal biology roswaal physics"</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>grades <span class="op">=</span> <span class="st">"dave 80 rem 66 ram 66 roswaal 100 emilia 88"</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>enrolled_in(Student, Course) <span class="op">&lt;-</span> py_rgx_string(enrolled, <span class="st">"(\w+).*?(\w+)"</span>)<span class="op">-&gt;</span>(Student, Course)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>student_grade(Student, Grade) <span class="op">&lt;-</span> py_rgx_string(grades, <span class="st">"(\w+).*?(\d+)"</span>) <span class="op">-&gt;</span> (Student, Grade)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>interesting_student(X) <span class="op">&lt;-</span> enrolled_in(X, <span class="st">"biology"</span>), enrolled_in(X, <span class="st">"chemistry"</span>), student_grade(X, <span class="st">"80"</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>?interesting_student(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'interesting_student(X)':
  X
------
 dave
</code></pre>
</div>
</div>
<p>in this case, the python implementation was long and unnatural. on the other hand, the spannerlog implementation was cleaner and allowed us to express our intentions directly, rather than dealing with annoying programming logic.</p>
</section>
</section>
<section id="parsing-json-document-using-spannerlog" class="level1">
<h1>Parsing JSON document using spannerlog</h1>
<p>spannerlog’s JsonPath/JsonFullPath ie functions allow us to easily parse json documents using path expressions.<br> We will demonstrate how to use the latter. Check out the <a href="https://github.com/json-path/JsonPath">jsonpath repo</a> for more information.</p>
<p>First, we would like to remove the built-in jsonpath function, to show how we implement it from scratch:</p>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>magic_session.remove_ie_function(<span class="st">"JsonPathFull"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After removing the function, implementing and registering it is as easy as:</p>
<div id="cell-84" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jsonpath_ng <span class="im">import</span> parse</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_match(match) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co">    @param match: a match result of json path query.</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co">    @return: a string that represents the match in string format.</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    json_result <span class="op">=</span> match.value</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">type</span>(json_result) <span class="op">!=</span> <span class="bu">str</span>:</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we replace for the same reason as in json_path implementation.</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>        json_result <span class="op">=</span> json.dumps(json_result).replace(<span class="st">"</span><span class="ch">\"</span><span class="st">"</span>, <span class="st">"'"</span>)</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json_result</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> json_path_full(json_document: <span class="bu">str</span>, path_expression: <span class="bu">str</span>):</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="co">    @param json_document: The document on which we will run the path expression.</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="co">    @param path_expression: The query to execute.</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="co">    @return: json documents with the full results paths.</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    json_document <span class="op">=</span> json.loads(json_document.replace(<span class="st">"'"</span>, <span class="st">"</span><span class="ch">\"</span><span class="st">"</span>))</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    jsonpath_expr <span class="op">=</span> parse(path_expression)</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> match <span class="kw">in</span> jsonpath_expr.find(json_document):</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>        json_result <span class="op">=</span> <span class="bu">str</span>(match.full_path)</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># objects in full path are separated by dots.</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> <span class="op">*</span>json_result.split(<span class="st">"."</span>), parse_match(match)</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>JsonPathFull <span class="op">=</span> <span class="bu">dict</span>(ie_function<span class="op">=</span>json_path_full,</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>            ie_function_name<span class="op">=</span><span class="st">'JsonPathFull'</span>,</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>            in_rel<span class="op">=</span>[DataTypes.string, DataTypes.string],</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>            out_rel<span class="op">=</span><span class="kw">lambda</span> arity: [DataTypes.string] <span class="op">*</span> arity,</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>magic_session.register(<span class="op">**</span>JsonPathFull)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now for the usage. <br> Suppose we have a json document of the following format {student: {subject: grade, …} ,…} <br> We want to create a rglox relation containing tuples of (student, subject, grade).</p>
<div id="cell-86" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we use strings, as spannerlog doesn't support dicts.</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>json_string <span class="op">=</span> <span class="st">"{ </span><span class="ch">\</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="st">                'abigail': {'chemistry': 80, 'operation systems': 99}, </span><span class="ch">\</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="st">                'jordan':  {'chemistry': 65, 'physics': 70}, </span><span class="ch">\</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="st">                'gale':    {'operation systems': 100}, </span><span class="ch">\</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="st">                'howard':  {'chemistry': 90, 'physics':91, 'biology':92} </span><span class="ch">\</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="st">                }"</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="co"># path expression is the path to the key of each grade (in our simple case it's *.*)</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="co"># then JsonPathFull appends the full path to the value</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>json_table(Student, Subject, Grade) <span class="op">&lt;-</span> JsonPathFull(json_string, <span class="st">"*.*"</span>) <span class="op">-&gt;</span> (Student, Subject, Grade)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>?json_table(Student, Subject, Grade)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>printing results for query 'json_table(Student, Subject, Grade)':
  Student  |      Subject      |   Grade
-----------+-------------------+---------
  abigail  |     chemistry     |      80
  abigail  | operation systems |      99
  jordan   |     chemistry     |      65
  jordan   |      physics      |      70
   gale    | operation systems |     100
  howard   |     chemistry     |      90
  howard   |      physics      |      91
  howard   |      biology      |      92
</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/DeanLight\.github\.io\/spannerlib");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/DeanLight/spannerlib/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>